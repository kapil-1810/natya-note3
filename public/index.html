<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natya Note - Choreography Assistant</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üé≠</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,600;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="/jspdf.umd.min.js"></script>
    <!-- TensorFlow.js for Pose Detection (FREE) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.0"></script>
    
    <style>
        * {
            box-sizing: border-box;
        }

        :root {
            --primary: #9d174d; /* Deep Pink */
            --bg: #fff1f2; /* Light Pink */
            --paper: #ffffff;
            --accent: #fbcfe8;
            --dark: #1a1a1a;
            --light-gray: #f5f5f5;
        }

        body {
            background: linear-gradient(135deg, var(--bg) 0%, #fce4ec 100%);
            color: #333;
            font-family: 'Lato', sans-serif;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        header {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 15px;
            width: 100%;
        }

        .subnav {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .subnav button, .subnav-btn {
            background: #fff;
            border: 1px solid var(--accent);
            color: #831843;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .subnav-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(157, 23, 77, 0.2);
        }

        h1 {
            font-family: 'Playfair Display', serif;
            color: var(--primary);
            font-size: clamp(1.8rem, 5vw, 2.5rem);
            margin: 0;
            letter-spacing: -0.5px;
        }

        p.subtitle {
            color: #831843;
            font-style: italic;
            opacity: 0.8;
            margin-top: 5px;
            font-size: clamp(0.85rem, 2vw, 1rem);
        }

        /* The Main Card */
        .workspace {
            background: var(--paper);
            width: 100%;
            max-width: 800px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(157, 23, 77, 0.15);
            padding: clamp(20px, 5vw, 30px);
            border: 2px solid var(--accent);
            margin-bottom: 20px;
        }

        /* Controls Row */
        .toolbar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            width: 100%;
        }

        select, button {
            padding: 12px 16px;
            border-radius: 10px;
            border: 2px solid var(--accent);
            background: white;
            font-family: 'Lato', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: clamp(0.9rem, 2vw, 1rem);
            font-weight: 500;
            min-height: 44px;
        }

        button {
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        button:active {
            transform: scale(0.98);
        }

        button.inspire-btn {
            background: linear-gradient(135deg, var(--primary), #c2185b);
            color: white;
            border: none;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 6px 20px rgba(157, 23, 77, 0.3);
        }
        
        button.inspire-btn:hover { 
            background: linear-gradient(135deg, #831843, #a00050);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(157, 23, 77, 0.4);
        }
        
        button.inspire-btn:active {
            transform: translateY(0);
        }

        /* Writing Area */
        .paper-area {
            position: relative;
        }

        textarea {
            width: 100%;
            padding: 20px;
            font-size: clamp(1rem, 2vw, 1.1rem);
            line-height: 1.6;
            border: 2px solid #f3e8ff;
            border-radius: 12px;
            background: white;
            font-family: 'Lato', sans-serif;
            resize: vertical;
            min-height: 200px;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(157, 23, 77, 0.1);
        }

        /* Media Tabs */
        .media-tabs {
            display: flex;
            gap: 8px;
            margin: 20px 0;
            flex-wrap: wrap;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 12px;
            overflow-x: auto;
        }

        .media-tab {
            padding: 10px 16px;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: clamp(0.85rem, 2vw, 0.95rem);
            white-space: nowrap;
            min-height: auto;
            box-shadow: none;
            font-weight: 500;
        }

        .media-tab:hover {
            background: rgba(157, 23, 77, 0.05);
        }

        .media-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(157, 23, 77, 0.2);
        }

        .media-content {
            display: none;
            padding: 20px 0;
            animation: fadeIn 0.3s ease;
        }

        .media-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        textarea:focus { border-color: var(--primary); background: #fff; }

        .beat-badge {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: #fdf2f8;
            color: var(--primary);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            border: 1px solid var(--accent);
        }

        /* AI Suggestion Box */
        .suggestion-box {
            margin-top: 20px;
            background: #fff0f5;
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 8px;
            display: none; /* Hidden by default */
        }
        .suggestion-text { font-style: italic; color: #555; }
        .add-btn {
            color: var(--primary);
            font-weight: bold;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 5px;
            display: inline-block;
        }

        /* Footer Actions */
        .actions {
            margin-top: 30px;
            display: flex;
            justify-content: flex-end;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        button.pdf-btn {
            background: #333;
            color: white;
            border: none;
        }
        
        button.action-btn {
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid var(--accent);
            background: white;
            font-family: 'Lato', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
        }

        /* New Feature Styles */
        .features-panel {
            background: #fdf2f8;
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .feature-box {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }

        .feature-box h4 {
            margin: 0 0 8px 0;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .feature-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .feature-controls button, .feature-controls select {
            padding: 6px 10px;
            font-size: 0.85rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background: white;
        }

        .timer-display {
            font-weight: bold;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .beat-grid {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .beat-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .beat-dot.active {
            background: var(--primary);
            color: white;
        }

        .beat-dot.sam {
            border: 2px solid var(--primary);
            font-weight: bold;
        }

        /* Video & Media Section */
        .media-section {
            background: linear-gradient(135deg, #fdf2f8 0%, #fff0f5 100%);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }

        .media-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .media-tab {
            padding: 8px 16px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .media-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .media-content {
            display: none;
        }

        .media-content.active {
            display: block;
        }

        .video-preview {
            width: 100%;
            max-width: 100%;
            height: 300px;
            background: #000;
            border-radius: 8px;
            margin: 10px 0;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .recorder-controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .recorder-controls button {
            padding: 8px 12px;
            border: 1px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .recorder-controls button:hover {
            background: var(--primary);
            color: white;
        }

        .recorder-status {
            font-size: 0.9rem;
            color: var(--primary);
            margin: 10px 0;
            font-weight: bold;
        }

        .recorder-status.recording::before {
            content: '‚óè ';
            color: #ff4444;
            animation: blink 1s infinite;
        }

        /* Enhanced Studio Mode */
        .studio-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 10000;
            flex-direction: column;
        }

        .studio-overlay.active {
            display: flex;
        }

        .studio-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .studio-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10001;
        }

        .studio-title {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .studio-feedback {
            position: absolute;
            bottom: 80px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10001;
        }

        .studio-feedback h4 {
            margin: 0 0 10px 0;
            color: #ff6b9d;
            font-size: 1.1rem;
        }

        .studio-metrics {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            min-width: 200px;
            z-index: 10001;
        }

        .studio-metrics h4 {
            margin: 0 0 10px 0;
            color: #ff6b9d;
            font-size: 1rem;
        }

        .studio-metric-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .studio-metric-value {
            color: #4CAF50;
            font-weight: bold;
        }

        .studio-timer {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 1.8rem;
            font-weight: bold;
            backdrop-filter: blur(10px);
            z-index: 10001;
        }

        .studio-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 10001;
        }

        .studio-controls button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .btn-record {
            background: rgba(255, 68, 68, 0.9);
            color: white;
        }

        .btn-record:hover {
            background: rgba(255, 68, 68, 1);
            transform: scale(1.05);
        }

        .btn-fullscreen {
            background: rgba(157, 23, 77, 0.9);
            color: white;
        }

        .btn-fullscreen:hover {
            background: rgba(157, 23, 77, 1);
            transform: scale(1.05);
        }

        .btn-exit {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-exit:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        /* Mobile Studio Mode */
        @media (max-width: 768px) {
            .studio-header {
                padding: 10px;
            }

            .studio-title {
                font-size: 1.2rem;
            }

            .studio-feedback {
                bottom: 100px;
                left: 10px;
                right: 10px;
                padding: 15px;
                max-height: 150px;
                font-size: 0.9rem;
            }

            .studio-metrics {
                top: 60px;
                right: 10px;
                padding: 10px;
                min-width: 150px;
                font-size: 0.85rem;
            }

            .studio-timer {
                font-size: 1.3rem;
                padding: 8px 16px;
            }

            .studio-controls {
                bottom: 10px;
                flex-wrap: wrap;
                gap: 8px;
            }

            .studio-controls button {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            header h1 {
                font-size: 1.8rem;
            }

            .workspace {
                padding: 15px;
                margin-top: 10px;
            }

            .subnav {
                flex-wrap: wrap;
                gap: 8px;
            }

            .subnav-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .features-panel {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .media-tabs {
                flex-wrap: wrap;
            }

            .video-preview {
                height: 200px;
            }

            .actions {
                flex-direction: column;
                gap: 10px;
            }

            button.action-btn {
                width: 100%;
                margin-right: 0;
            }

            /* Practice mode mobile layout */
            [style*="display:grid"][style*="grid-template-columns:2fr 1.2fr"] {
                grid-template-columns: 1fr !important;
            }

            [style*="grid-template-columns:1.2fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            /* Hide some elements on very small screens */
            @media (max-width: 480px) {
                .beat-badge {
                    font-size: 0.75rem;
                    padding: 4px 8px;
                }
                
                #poseMetrics {
                    grid-template-columns: 1fr !important;
                    font-size: 0.85rem;
                }
            }
        }

        .notes-list {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }

        .note-item {
            background: #fdf2f8;
            padding: 8px;
            margin: 5px 0;
            border-left: 3px solid var(--primary);
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-time {
            font-size: 0.8rem;
            color: #999;
        }

        .note-delete {
            background: #ff4444;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .music-upload {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
            width: 100%;
            margin: 15px 0;
        }

        .music-upload input[type="file"] {
            padding: 12px;
            border: 2px dashed var(--primary);
            border-radius: 10px;
            background: #fdf2f8;
            cursor: pointer;
            font-size: 0.95rem;
            color: #666;
            transition: all 0.3s ease;
        }

        .music-upload input[type="file"]:hover {
            background: #fce4ec;
            border-color: #c2185b;
        }

        .music-player {
            width: 100%;
            margin: 15px 0;
            padding: 12px;
            background: linear-gradient(135deg, #fff5f7, #fce4ec);
            border-radius: 12px;
            border: 2px solid var(--accent);
        }

        .music-player:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(157, 23, 77, 0.2);
        }

        /* Style audio controls for mobile */
        .music-player::webkit-slider-thumb {
            height: 18px;
            width: 18px;
            border-radius: 50%;
        }

        .now-playing {
            color: var(--primary);
            font-weight: bold;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        /* New Feature Styles */
        .recording-item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--primary);
        }

        .recording-info {
            flex: 1;
        }

        .recording-name {
            font-weight: bold;
            color: #333;
        }

        .recording-time {
            font-size: 0.8rem;
            color: #999;
        }

        .recording-actions {
            display: flex;
            gap: 5px;
        }

        .recording-actions button {
            padding: 4px 8px;
            font-size: 0.8rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .btn-play {
            background: #60a5fa;
            color: white;
        }

        .btn-delete {
            background: #ff4444;
            color: white;
        }

        .streak-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff6b6b, #ffa07a);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }

        .streak-number {
            font-size: 2rem;
            display: block;
        }

        .speed-controls {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .speed-btn {
            padding: 8px 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .speed-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .studio-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .studio-overlay.active {
            display: flex;
        }

        .studio-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .studio-controls {
            position: absolute;
            bottom: 20px;
            display: flex;
            gap: 15px;
            background: rgba(0,0,0,0.8);
            padding: 15px 30px;
            border-radius: 12px;
        }

        .studio-controls button {
            padding: 12px 24px;
            font-size: 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-exit {
            background: #ff4444;
            color: white;
        }

        .btn-record {
            background: #4CAF50;
            color: white;
        }

        .studio-timer {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .voice-memo-item {
            background: #fdf2f8;
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .voice-memo-text {
            flex: 1;
        }

        .voice-time {
            font-size: 0.8rem;
            color: #999;
        }

        .voice-play {
            padding: 6px 12px;
            background: #60a5fa;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        /* ===== MOBILE RESPONSIVE ===== */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .workspace {
                width: 100%;
                padding: clamp(15px, 4vw, 25px);
                border-radius: 16px;
                margin: 0 10px 20px 10px;
            }

            .toolbar {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            select, button {
                padding: 14px 16px;
                font-size: 1rem;
                min-height: 48px;
            }

            textarea {
                min-height: 200px;
                padding: 16px;
                font-size: 1rem;
            }

            .media-tabs {
                gap: 6px;
                padding-bottom: 10px;
                margin: 15px 0;
            }

            .media-tab {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .video-preview {
                height: 250px;
            }

            .music-player {
                height: 60px;
            }

            .features-panel {
                display: grid;
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .feature-box {
                padding: 15px;
            }

            .feature-controls {
                flex-wrap: wrap;
                gap: 8px;
            }

            .feature-controls button, .feature-controls select {
                flex: 1;
                min-width: 80px;
            }

            .recorder-controls {
                flex-direction: column;
            }

            .recorder-controls button {
                width: 100%;
                padding: 12px;
            }

            .studio-controls {
                flex-wrap: wrap;
                width: 90%;
                bottom: 10px;
                padding: 12px 15px;
            }

            .studio-controls button {
                flex: 1;
                min-width: 100px;
                padding: 10px 12px;
                font-size: 0.9rem;
            }

            video {
                max-width: 100%;
            }

            .recording-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .recording-info {
                width: 100%;
            }

            .recording-actions {
                width: 100%;
                display: flex;
                gap: 8px;
            }

            .recording-actions button {
                flex: 1;
                padding: 8px;
                font-size: 0.85rem;
            }

            .voice-memo-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .voice-memo-item audio {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 0;
            }

            .workspace {
                margin: 0 0 15px 0;
                padding: 15px;
                border-radius: 12px;
            }

            h1 {
                font-size: 1.5rem;
            }

            header {
                margin-top: 10px;
                margin-bottom: 10px;
            }

            p.subtitle {
                font-size: 0.8rem;
            }

            select, button {
                font-size: 0.95rem;
                padding: 12px 14px;
                min-height: 44px;
            }

            .toolbar {
                grid-template-columns: 1fr;
            }

            textarea {
                font-size: 1rem;
                padding: 12px;
                min-height: 180px;
            }

            .media-tabs {
                gap: 4px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .media-tab {
                padding: 6px 10px;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            .beat-badge {
                font-size: 0.8rem;
                padding: 6px 10px;
            }

            .feature-box h4 {
                font-size: 0.95rem;
                margin: 8px 0;
            }

            .feature-box {
                padding: 12px;
            }

            .speed-btn {
                padding: 8px 10px;
                font-size: 0.8rem;
            }

            .studio-controls {
                bottom: 5px;
                padding: 10px 12px;
                gap: 8px;
            }

            .studio-controls button {
                padding: 8px 10px;
                font-size: 0.85rem;
            }

            /* Make audio player taller on tiny screens */
            .music-player {
                height: 55px;
            }

            input[type="file"] {
                padding: 10px;
                font-size: 0.9rem;
            }

            .recording-item {
                padding: 10px;
                font-size: 0.9rem;
            }

            .note-item {
                padding: 6px;
                font-size: 0.85rem;
            }
        }

        /* Portrait mode adjustments */
        @media (orientation: portrait) {
            .studio-controls {
                flex-direction: column;
                width: 85%;
            }

            .studio-controls button {
                width: 100%;
                padding: 12px;
            }
        }

        /* Landscape mode adjustments */
        @media (orientation: landscape) and (max-height: 600px) {
            .workspace {
                margin-top: 5px;
                margin-bottom: 5px;
            }

            textarea {
                min-height: 150px;
            }

            .video-preview {
                height: 200px;
            }
        }
    </style>

</head>
<body>

    <header>
        <h1>üé≠ Natya Note</h1>
        <p class="subtitle">Your Digital Kathak Choreography Companion</p>
        <div class="subnav">
            <button onclick="showSection('write')" class="subnav-btn active">üìù Notebook</button>
            <button onclick="showSection('features')" class="subnav-btn">üéõÔ∏è Practice Tools</button>
            <button onclick="showSection('ai-tools')" class="subnav-btn">ü§ñ AI Tools</button>
            <button onclick="showSection('media')" class="subnav-btn">üé• Media</button>
            <button onclick="showSection('pose-training')" class="subnav-btn">üéØ Advanced Training</button>
        </div>
    </header>

    <div class="workspace">
        
        <div class="toolbar">
            <select id="taal">
                <option value="Teen Taal (16 Beats)">Teen Taal (16)</option>
                <option value="Jhap Taal (10 Beats)">Jhap Taal (10)</option>
                <option value="Rupak Taal (7 Beats)">Rupak Taal (7)</option>
                <option value="Dadra (6 Beats)">Dadra (6)</option>
            </select>
            
            <select id="stepType">
                <option value="Tihai">Ending (Tihai)</option>
                <option value="Toda">Fast Sequence (Toda)</option>
                <option value="Chakkar">Spins (Chakkar)</option>
                <option value="Aamad">Entrance (Aamad)</option>
            </select>

            <button class="inspire-btn" onclick="askAI()">
                ‚ú® Inspire Me
            </button>
        </div>

        <div class="paper-area" id="write" data-section>
            <textarea id="notebook" placeholder="Start typing your Bol here... (e.g. Dha Dhin Dhin Dha)"></textarea>
            <div id="beatCounter" class="beat-badge">0 Beats</div>
        </div>

        <!-- NEW: Features Panel -->
        <div class="features-panel" id="features" data-section style="display:none;">
            <!-- Metronome -->
            <div class="feature-box">
                <h4>üéµ Metronome</h4>
                <div class="feature-controls">
                    <select id="tempo" style="width: 80px;">
                        <option value="60">60 BPM</option>
                        <option value="80">80 BPM</option>
                        <option value="100" selected>100 BPM</option>
                        <option value="120">120 BPM</option>
                        <option value="140">140 BPM</option>
                    </select>
                    <button onclick="toggleMetronome()" id="metroBtn">‚ñ∂ Play</button>
                </div>
            </div>

            <!-- Difficulty Level -->
            <div class="feature-box">
                <h4>üéØ Difficulty</h4>
                <div class="feature-controls">
                    <button onclick="setDifficulty('easy')" id="diffEasy" class="difficulty-btn">Easy</button>
                    <button onclick="setDifficulty('medium')" id="diffMedium" class="difficulty-btn">Medium</button>
                    <button onclick="setDifficulty('hard')" id="diffHard" class="difficulty-btn">Hard</button>
                </div>
            </div>

            <!-- Practice Timer -->
            <div class="feature-box">
                <h4>‚è±Ô∏è Practice Session</h4>
                <div class="timer-display" id="timerDisplay">0:00</div>
                <div class="feature-controls">
                    <button onclick="startTimer()">Start</button>
                    <button onclick="stopTimer()">Stop</button>
                    <button onclick="resetTimer()">Reset</button>
                </div>
            </div>

            <!-- Taal Visualizer -->
            <div class="feature-box">
                <h4>üìä Beat Structure</h4>
                <div class="beat-grid" id="beatGrid"></div>
            </div>
        </div>

                <!-- AI Tools Panel -->
                <div class="ai-panel" id="ai-tools" data-section style="margin:18px 0; padding:12px; background:#fff; border-radius:8px; display:none;">
                    <h4 style="margin-top:0;">ü§ñ AI Tools</h4>
                    <div style="display:flex;gap:12px;flex-wrap:wrap;">
                        <div style="flex:1;min-width:220px;">
                            <label style="font-weight:600">Bol Explainer</label>
                            <input id="aiBolInput" placeholder="e.g. Dhin" style="width:100%;margin-top:6px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                            <button onclick="explainBol()" style="margin-top:8px;">Explain Bol</button>
                        </div>
                        <div style="flex:1;min-width:280px;">
                            <label style="font-weight:600">Variations</label>
                            <input id="aiVarsInput" placeholder="e.g. Dha Dhin Dhin Dha" style="width:100%;margin-top:6px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                            <input id="aiVarsCount" type="number" value="3" min="1" max="6" style="width:70px;margin-top:8px;margin-right:8px;">
                            <button onclick="generateVariations()" style="margin-top:8px;">Generate Variations</button>
                        </div>
                        <div style="flex:1;min-width:260px;">
                            <label style="font-weight:600">Practice Plan</label>
                            <select id="aiPlanLevel" style="width:100%;margin-top:6px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                            <input id="aiPlanMins" type="number" value="30" min="5" style="width:120px;margin-top:8px;">
                            <button onclick="generatePlan()" style="margin-top:8px;">Create 7-day Plan</button>
                        </div>
                    </div>
                    <div id="aiOutput" style="margin-top:12px; background:#f9f9f9; padding:10px; border-radius:6px; min-height:60px; white-space:pre-wrap;"></div>
                    <!-- Choreography Generator -->
                    <div style="margin-top:24px; padding:14px; background:#f3e8ff; border-radius:8px;">
                        <label style="font-weight:600;">üéº Choreography Generator</label>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;">
                            <select id="choreoTaal" style="flex:1;min-width:120px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                <option value="Teen Taal (16 Beats)">Teen Taal (16)</option>
                                <option value="Jhap Taal (10 Beats)">Jhap Taal (10)</option>
                                <option value="Rupak Taal (7 Beats)">Rupak Taal (7)</option>
                                <option value="Dadra (6 Beats)">Dadra (6)</option>
                            </select>
                            <select id="choreoLevel" style="flex:1;min-width:120px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                <option value="beginner">Beginner</option>
                                <option value="intermediate" selected>Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                            <input id="choreoTheme" placeholder="Theme (e.g. Rain, Krishna)" style="flex:2;min-width:160px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                            <select id="choreoLength" style="flex:1;min-width:100px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                <option value="3">3 Steps</option>
                                <option value="5" selected>5 Steps</option>
                                <option value="7">7 Steps</option>
                                <option value="10">10 Steps</option>
                            </select>
                            <button onclick="generateChoreo()" style="padding:8px 16px;background:var(--primary);color:white;border:none;border-radius:6px;font-weight:bold;cursor:pointer;white-space:nowrap;">‚ú® Generate</button>
                        </div>
                        <div id="choreoOutput" style="margin-top:12px; background:#f9f9f9; padding:10px; border-radius:6px; min-height:60px;"></div>
                        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap" id="choreActionButtons" style="display:none;">
                            <button onclick="saveChoreoToNotebook()" style="padding:8px 12px;border:1px solid var(--accent);background:#fff;border-radius:6px;cursor:pointer;font-weight:500;">üíæ Save</button>
                            <button onclick="downloadChoreoPDF()" style="padding:8px 12px;background:#333;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:500;">üìÑ PDF</button>
                            <button onclick="copyChoreoJSON()" style="padding:8px 12px;border:1px solid var(--accent);background:#fff;border-radius:6px;cursor:pointer;font-weight:500;">üìã JSON</button>
                        </div>
                        <script>
                            // Modern choreography renderer with clean cards
                            function renderChoreo(choreo) {
                                const container = document.getElementById('choreoOutput');
                                if (!Array.isArray(choreo) || !choreo.length) {
                                    container.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">‚ùå No choreography generated. Try again!</div>';
                                    return;
                                }
                                const html = choreo.map((s, i) => {
                                    const section = (s.section || `Section ${i+1}`).toString();
                                    const bol = (s.bol || '').toString();
                                    const movement = (s.movement || '').toString();
                                    const comment = (s.commentary || '').toString();
                                    return `<div style="background:#fff;padding:14px;border-radius:8px;margin:10px 0;border-left:5px solid var(--primary);box-shadow:0 2px 8px rgba(0,0,0,0.05)">
                                        <div style="font-weight:700;color:var(--primary);font-size:1.05rem;margin-bottom:6px">üìç ${section}</div>
                                        <div style="margin:8px 0">
                                            <span style="display:inline-block;background:linear-gradient(135deg,#f3e8ff,#e9d5ff);color:#4A044E;border:1px solid #d8b4fe;padding:6px 12px;border-radius:14px;font-family:monospace;font-weight:600">üéº ${bol}</span>
                                        </div>
                                        <div style="color:#333;line-height:1.6;margin:8px 0;font-size:0.95rem">${movement}</div>
                                        ${comment ? `<div style="margin-top:8px;padding:8px;background:#fdf2f8;color:#6b7280;font-style:italic;border-left:2px solid #fbcfe8">üí≠ ${comment}</div>` : ''}</div>`;
                                }).join('');
                                container.innerHTML = `<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">${html}</div>`;
                                window.__latestChoreo = choreo;
                            }
                        </script>
                        <div style="display:none" id="choreActionButtons">
                            <button onclick="saveChoreoToNotebook()" style="padding:8px 12px;border:1px solid var(--accent);background:#fff;border-radius:6px;cursor:pointer">üíæ Save to Notebook</button>
                            <button onclick="downloadChoreoPDF()" style="padding:8px 12px;background:#333;color:#fff;border:none;border-radius:6px;cursor:pointer">üìÑ Download PDF</button>
                            <button onclick="copyChoreoJSON()" style="padding:8px 12px;border:1px solid var(--accent);background:#fff;border-radius:6px;cursor:pointer">üìã Copy JSON</button>
                        </div>
                        <script>
                            function saveChoreoToNotebook() {
                                const area = document.getElementById('notebook');
                                const choreo = window.__latestChoreo || [];
                                if (!choreo.length) return;
                                const text = choreo.map((s,i)=>{
                                    const section = s.section || `Section ${i+1}`;
                                    const bol = s.bol || '';
                                    const movement = s.movement || '';
                                    const comment = s.commentary ? `\nCommentary: ${s.commentary}` : '';
                                    return `${section} ‚Äî ${bol}\n${movement}${comment}`;
                                }).join('\n\n---\n\n');
                                area.value = (area.value ? area.value + '\n\n---\n\n' : '') + text;
                                alert('‚úÖ Choreography saved to notebook!');
                            }

                            function downloadChoreoPDF() {
                                const choreo = window.__latestChoreo || [];
                                if (!choreo.length || !window.jspdf) return;
                                const { jsPDF } = window.jspdf;
                                const doc = new jsPDF();
                                let y = 15;
                                doc.setFontSize(16);
                                doc.setTextColor(157, 23, 77);
                                doc.text('Natya Note ‚Äî Choreography', 15, y);
                                y += 10;
                                doc.setFontSize(11);
                                doc.setTextColor(100);
                                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 15, y);
                                y += 10;
                                doc.setDrawColor(200);
                                doc.line(15, y, 195, y);
                                y += 8;
                                doc.setTextColor(0);
                                choreo.forEach((s,i)=>{
                                    const section = s.section || `Section ${i+1}`;
                                    const bol = s.bol || '';
                                    const movement = s.movement || '';
                                    doc.setFont(undefined, 'bold');
                                    doc.setTextColor(157, 23, 77);
                                    doc.text(`${section} ‚Äî ${bol}`, 15, y);
                                    y += 6;
                                    doc.setFont(undefined, 'normal');
                                    doc.setTextColor(0);
                                    const lines = doc.splitTextToSize(movement, 170);
                                    lines.forEach(line=>{ doc.text(line, 15, y); y += 5; });
                                    if (s.commentary) {
                                        doc.setFont(undefined, 'italic');
                                        doc.setTextColor(100);
                                        const cLines = doc.splitTextToSize(`Note: ${s.commentary}`, 170);
                                        cLines.forEach(line=>{ doc.text(line, 15, y); y += 5; });
                                        doc.setFont(undefined, 'normal');
                                        doc.setTextColor(0);
                                    }
                                    y += 5;
                                    if (y > 260) { doc.addPage(); y = 15; }
                                });
                                doc.save('natya-choreography.pdf');
                                alert('üì• PDF downloaded!');
                            }

                            function copyChoreoJSON() {
                                const choreo = window.__latestChoreo || [];
                                if (!choreo.length) return;
                                const json = JSON.stringify(choreo, null, 2);
                                navigator.clipboard.writeText(json).then(() => {
                                    alert('‚úÖ Choreography JSON copied to clipboard!');
                                }).catch(() => {
                                    alert('Could not copy to clipboard');
                                });
                            }
                        </script>
                        <!-- AI Feedback Tool -->
                        <div style="margin-top:24px; padding:14px; background:#e0f7fa; border-radius:8px;">
                            <label style="font-weight:600;">AI Feedback (Video/Notes)</label>
                            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;align-items:center;">
                                <input type="file" id="feedbackVideo" accept="video/*" style="flex:2;min-width:160px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                <input id="feedbackNotes" placeholder="Notes about your practice" style="flex:3;min-width:180px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                <select id="feedbackTaal" style="flex:1;min-width:120px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                    <option value="Teen Taal (16 Beats)">Teen Taal (16)</option>
                                    <option value="Jhap Taal (10 Beats)">Jhap Taal (10)</option>
                                    <option value="Rupak Taal (7 Beats)">Rupak Taal (7)</option>
                                    <option value="Dadra (6 Beats)">Dadra (6)</option>
                                </select>
                                <select id="feedbackLevel" style="flex:1;min-width:120px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                    <option value="beginner">Beginner</option>
                                    <option value="intermediate">Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                                <button onclick="getFeedback()" style="padding:8px 16px;background:var(--primary);color:white;border:none;border-radius:6px;font-weight:bold;">Get Feedback</button>
                            </div>
                            <div id="feedbackOutput" style="margin-top:12px; background:#f9f9f9; padding:10px; border-radius:6px; min-height:60px; white-space:pre-wrap;"></div>
                            <!-- AI Pose Suggestion Tool -->
                            <div style="margin-top:24px; padding:14px; background:#f1f8e9; border-radius:8px;">
                                <label style="font-weight:600;">AI Pose Suggestions</label>
                                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;align-items:center;">
                                    <select id="poseTaal" style="flex:1;min-width:120px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                        <option value="Teen Taal (16 Beats)">Teen Taal (16)</option>
                                        <option value="Jhap Taal (10 Beats)">Jhap Taal (10)</option>
                                        <option value="Rupak Taal (7 Beats)">Rupak Taal (7)</option>
                                        <option value="Dadra (6 Beats)">Dadra (6)</option>
                                    </select>
                                    <select id="poseLevel" style="flex:1;min-width:120px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                        <option value="beginner">Beginner</option>
                                        <option value="intermediate">Intermediate</option>
                                        <option value="advanced">Advanced</option>
                                    </select>
                                    <input id="poseTheme" placeholder="Theme (e.g. Krishna, Rain)" style="flex:2;min-width:160px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                    <button onclick="getPoseSuggestions()" style="padding:8px 16px;background:var(--primary);color:white;border:none;border-radius:6px;font-weight:bold;">Suggest Poses</button>
                                </div>
                                <div id="poseOutput" style="margin-top:12px; background:#f9f9f9; padding:10px; border-radius:6px; min-height:60px; white-space:pre-wrap;"></div>
                                <!-- AI Practice Reminder Tool -->
                                <div style="margin-top:24px; padding:14px; background:#fffde7; border-radius:8px;">
                                    <label style="font-weight:600;">AI Practice Reminder</label>
                                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;align-items:center;">
                                        <input id="reminderHistory" placeholder="Recent practice (e.g. 3 days, chakkar focus)" style="flex:2;min-width:160px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                        <input id="reminderGoals" placeholder="Your goals (e.g. sharper arms)" style="flex:2;min-width:160px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                        <button onclick="getReminder()" style="padding:8px 16px;background:var(--primary);color:white;border:none;border-radius:6px;font-weight:bold;">Get Reminder</button>
                                    </div>
                                    <div id="reminderOutput" style="margin-top:12px; background:#f9f9f9; padding:10px; border-radius:6px; min-height:60px; white-space:pre-wrap;"></div>
                                    <!-- AI Mood-based Practice Tool -->
                                    <div style="margin-top:24px; padding:14px; background:#e3f2fd; border-radius:8px;">
                                        <label style="font-weight:600;">Mood-based Practice Plan</label>
                                        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;align-items:center;">
                                            <select id="moodMood" style="flex:1;min-width:120px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                                <option value="Energetic">Energetic</option>
                                                <option value="Tired">Tired</option>
                                                <option value="Focused">Focused</option>
                                                <option value="Stressed">Stressed</option>
                                                <option value="Playful">Playful</option>
                                                <option value="Calm">Calm</option>
                                            </select>
                                            <input id="moodTime" type="number" min="5" value="30" placeholder="Minutes" style="flex:1;min-width:80px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                            <input id="moodGoals" placeholder="Goals (e.g. spins, stamina)" style="flex:2;min-width:160px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                            <button onclick="getMoodPractice()" style="padding:8px 16px;background:var(--primary);color:white;border:none;border-radius:6px;font-weight:bold;">Get Plan</button>
                                        </div>
                                        <div id="moodOutput" style="margin-top:12px; background:#f9f9f9; padding:10px; border-radius:6px; min-height:60px; white-space:pre-wrap;"></div>
                                        <!-- AI Gesture Dictionary Tool -->
                                        <div style="margin-top:24px; padding:14px; background:#fce4ec; border-radius:8px;">
                                            <label style="font-weight:600;">Gesture (Mudra) Dictionary</label>
                                            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;align-items:center;">
                                                <input id="gestureName" placeholder="Gesture name (e.g. Pataka)" style="flex:2;min-width:160px;padding:8px;border-radius:6px;border:1px solid #ddd;">
                                                <button onclick="getGestureInfo()" style="padding:8px 16px;background:var(--primary);color:white;border:none;border-radius:6px;font-weight:bold;">Explain Gesture</button>
                                            </div>
                                            <div id="gestureOutput" style="margin-top:12px; background:#f9f9f9; padding:10px; border-radius:6px; min-height:60px; white-space:pre-wrap;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Media Section (Video, Notes, Music) -->
        <div class="media-section" id="media" data-section style="display:none;">
            <div class="media-tabs">
                <button class="media-tab active" onclick="switchTab('video')">üé• Video Recorder</button>
                <button class="media-tab" onclick="switchTab('recordings')">üìÅ Recordings</button>
                <button class="media-tab" onclick="switchTab('voice')">üé§ Voice Memos</button>
                <button class="media-tab" onclick="switchTab('speed')">‚ö° Speed Trainer</button>
                <button class="media-tab" onclick="switchTab('streak')">üî• Streak & Stats</button>
                <button class="media-tab" onclick="switchTab('voicenote')">üó£Ô∏è Voice Notes</button>
                <button class="media-tab" onclick="switchTab('comparison')">üìä Compare Videos</button>
                <button class="media-tab" onclick="switchTab('challenges')">üéØ Daily Challenges</button>
                <button class="media-tab" onclick="switchTab('music')">üéµ Music Player</button>
            </div>

            <!-- Video Recorder Tab -->
            <div id="video-content" class="media-content active">
                <p style="font-size: 0.9rem; color: #666;">Record your practice sessions to review later</p>
                <video id="videoPreview" class="video-preview" autoplay muted playsinline></video>
                <div class="recorder-controls">
                    <button onclick="startVideoRecorder()">‚ñ∂ Start Recording</button>
                    <button onclick="stopVideoRecorder()">‚èπ Stop Recording</button>
                    <button onclick="enterStudioMode()">üé¨ Studio Mode</button>
                    <button onclick="downloadVideo()">‚¨áÔ∏è Download Video</button>
                </div>
                <div id="recorderStatus" class="recorder-status"></div>
            </div>

            <!-- Segment Notes Tab (Removed - replaced with new features) -->

            <!-- NEW: Recordings Library Tab -->
            <div id="recordings-content" class="media-content">
                <p style="font-size: 0.9rem; color: #666;">Your saved practice recordings</p>
                <div id="recordingsList" class="notes-list" style="min-height: 200px;">
                    <p style="text-align: center; color: #999;">No recordings yet</p>
                </div>
            </div>

            <!-- NEW: Voice Memos Tab -->
            <div id="voice-content" class="media-content">
                <p style="font-size: 0.9rem; color: #666;">Quick voice notes about your practice</p>
                <div class="recorder-controls">
                    <button onclick="startVoiceMemo()">üéôÔ∏è Start Recording</button>
                    <button onclick="stopVoiceMemo()">‚èπ Stop</button>
                </div>
                <div id="voiceMemosList" class="notes-list" style="min-height: 150px;">
                    <p style="text-align: center; color: #999;">No voice memos yet</p>
                </div>
            </div>

            <!-- NEW: Speed Trainer Tab -->
            <div id="speed-content" class="media-content">
                <p style="font-size: 0.9rem; color: #666;">Practice your choreography at different speeds</p>
                <div class="speed-controls">
                    <button class="speed-btn active" onclick="setSpeed(1.0)">1.0x</button>
                    <button class="speed-btn" onclick="setSpeed(1.25)">1.25x</button>
                    <button class="speed-btn" onclick="setSpeed(1.5)">1.5x</button>
                    <button class="speed-btn" onclick="setSpeed(2.0)">2.0x</button>
                </div>
                <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 10px;">
                    <p style="font-size: 0.9rem; color: #666; margin: 0 0 10px 0;">Your choreography at current speed:</p>
                    <div id="speedDisplayText" style="font-size: 1.1rem; font-weight: bold; color: var(--primary); line-height: 1.8; word-spacing: 8px;">Type or paste your bols to practice...</div>
                </div>
            </div>

            <!-- NEW: Streak & Stats Tab -->
            <div id="streak-content" class="media-content">
                <p style="font-size: 0.9rem; color: #666;">Track your practice consistency and motivation</p>
                <div style="text-align: center;">
                    <div class="streak-badge">
                        <div class="streak-number" id="streakNumber">0</div>
                        <div>Day Streak üî•</div>
                    </div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--primary);">üìä Practice Stats</h4>
                    <p>Total Practice Time: <strong id="totalPracticeTime">0h 0m</strong></p>
                    <p>Sessions This Week: <strong id="sessionsThisWeek">0</strong></p>
                    <p>Last Practice: <strong id="lastPracticeTime">Never</strong></p>
                    <button onclick="recordPracticeSession()" style="background: var(--primary); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px;">‚úÖ Mark Practice Done Today</button>
                </div>
            </div>

            <!-- Music Player Tab -->
            <div id="music-content" class="media-content">
                <div style="background: linear-gradient(135deg, #fdf2f8, #fce4ec); padding: 20px; border-radius: 12px; border: 2px solid var(--accent);">
                    <h3 style="margin-top: 0; color: var(--primary); font-size: 1.2rem;">üéµ Practice Music</h3>
                    <p style="font-size: 0.95rem; color: #666; margin: 10px 0;">Upload background music to practice with</p>
                    
                    <div class="music-upload">
                        <div style="border: 2px dashed var(--primary); border-radius: 10px; padding: 15px; background: white; text-align: center; cursor: pointer;" onclick="document.getElementById('musicFile').click();">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üéº</div>
                            <input type="file" id="musicFile" accept="audio/*" onchange="loadMusic()" style="display: none;">
                            <div style="font-weight: bold; color: var(--primary);">Click to upload music</div>
                            <div style="font-size: 0.85rem; color: #999; margin-top: 5px;">or drag & drop</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid var(--accent); width: 100%; text-align: center;">
                            <div style="font-size: 0.85rem; color: #999;">Currently selected:</div>
                            <span id="musicFileName" style="color: var(--primary); font-weight: bold; display: block; margin-top: 5px;">No music uploaded</span>
                        </div>
                    </div>

                    <audio id="audioPlayer" class="music-player" controls style="margin-top: 15px;"></audio>
                    
                    <div id="nowPlaying" class="now-playing" style="text-align: center; padding: 10px; margin-top: 10px; background: white; border-radius: 8px; display: none;"></div>

                        <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid var(--primary);">
                            <div style="font-size: 0.85rem; color: #666;">
                                <strong>üí° Tip:</strong> Upload your favorite Kathak music or compositions to practice along with the beats. You can adjust the volume and replay as needed.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                    </script>
                </div>
            </div>

            <!-- NEW: Voice-to-Text Notes Tab -->
            <div id="voicenote-content" class="media-content">
                <p style="font-size: 0.9rem; color: #666;">Speak notes instead of typing them</p>
                <div class="recorder-controls">
                    <button onclick="startVoiceToText()" id="voiceToTextBtn">üé§ Start Speaking</button>
                    <button onclick="stopVoiceToText()" id="stopVoiceToTextBtn" style="display: none;">‚èπ Stop</button>
                </div>
                <div id="voiceToTextStatus" style="color: #666; margin: 10px 0; font-weight: bold;"></div>
                <textarea id="voiceToTextArea" placeholder="Your spoken notes will appear here..." style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-top: 10px;"></textarea>
                <button onclick="saveVoiceNote()" style="background: var(--primary); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px;">üíæ Save Note</button>
            </div>

            <!-- NEW: Video Comparison Tab -->
            <div id="comparison-content" class="media-content">
                <p style="font-size: 0.9rem; color: #666;">Compare your recording with a reference video side-by-side</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
                    <div>
                        <p style="font-weight: bold; color: var(--primary);">Your Recording</p>
                        <select id="yourRecording" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option>Select your recording...</option>
                        </select>
                        <video id="yourVideo" style="width: 100%; background: #000; border-radius: 6px; margin-top: 10px;" controls></video>
                    </div>
                    <div>
                        <p style="font-weight: bold; color: var(--primary);">Reference Video</p>
                        <input type="file" id="referenceVideo" accept="video/*" onchange="loadReferenceVideo()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <video id="refVideo" style="width: 100%; background: #000; border-radius: 6px; margin-top: 10px;" controls></video>
                    </div>
                </div>
                <button onclick="syncVideos()" style="background: #60a5fa; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px;">üîÑ Sync Play</button>
            </div>

            <!-- NEW: Daily Challenges Tab -->
            <div id="challenges-content" class="media-content">
                <p style="font-size: 0.9rem; color: #666;">Daily practice challenges to improve your skills</p>
                <div id="challengesContainer" style="background: white; padding: 15px; border-radius: 6px; margin-top: 10px;">
                    <div id="dailyChallengeBox" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="margin: 0 0 10px 0;" id="challengeTitle">Today's Challenge</h3>
                        <p id="challengeDesc" style="font-size: 0.95rem; margin: 0 0 15px 0;"></p>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="startChallenge()" style="background: white; color: #667eea; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">‚ñ∂ Start Challenge</button>
                            <button onclick="skipChallenge()" style="background: rgba(255,255,255,0.3); color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">‚è≠Ô∏è Skip</button>
                        </div>
                    </div>
                    <div id="challengeProgress" style="margin-top: 15px;">
                        <h4 style="color: var(--primary);">Challenge Progress</h4>
                        <p>Challenges Completed Today: <strong id="completedChallengesCount">0</strong>/3</p>
                        <div id="completedChallengesList"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="aiBox" class="suggestion-box">
            <strong>‚ú® AI Suggestion:</strong>
            <p id="aiText" class="suggestion-text">Loading...</p>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <span class="add-btn" onclick="acceptSuggestion()">+ Add to composition</span>
                <span class="add-btn" onclick="copySuggestion()">üìã Copy</span>
            </div>
        </div>

        <div class="actions">
            <button class="action-btn" onclick="clearNotes()" style="background: #f87171; color: white; border: none;">üóëÔ∏è Clear</button>
            <button class="action-btn" onclick="saveComposition()" style="background: #60a5fa; color: white; border: none;">üíæ Save</button>
            <button class="pdf-btn" onclick="generatePDF()">üìÑ Download PDF Notes</button>
        </div>

        <!-- NEW: Advanced Pose Training Section (FREE) -->
        <div class="pose-training-section" id="pose-training" data-section style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <div>
                    <h2 style="color: var(--primary); margin: 0;">üéØ AI Pose Training (Free)</h2>
                    <p style="font-size: 0.9rem; color: #666; margin: 5px 0 0 0;">Real-time posture analysis using your camera. Everything runs on your device - 100% free!</p>
                </div>
                <button onclick="toggleHelpGuide()" style="background:#2196F3; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold; font-size:0.95rem;">‚ùì Quick Start Guide</button>
            </div>

            <!-- Quick Start Guide Collapsible -->
            <div id="helpGuide" style="display:none; background:linear-gradient(135deg, #e3f2fd, #fff3e0); border:2px solid #2196F3; border-radius:12px; padding:20px; margin:15px 0;">
                <h3 style="color:#1976d2; margin:0 0 15px 0; display:flex; align-items:center; gap:10px;">
                    üí° How to Use Advanced Training
                    <button onclick="toggleHelpGuide()" style="background:none; border:none; color:#666; cursor:pointer; font-size:1.5rem; margin-left:auto;">√ó</button>
                </h3>
                
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:15px;">
                    <div style="background:white; padding:15px; border-radius:8px; border-left:4px solid #4CAF50;">
                        <h4 style="color:#4CAF50; margin:0 0 10px 0;">üëâ Step 1: Start Camera</h4>
                        <p style="margin:0; font-size:0.9rem; line-height:1.6;">
                            Click <strong>"üìπ Start Camera"</strong> to enable your webcam. Position yourself so your full body is visible (from head to feet if possible).
                        </p>
                    </div>

                    <div style="background:white; padding:15px; border-radius:8px; border-left:4px solid #ff9800;">
                        <h4 style="color:#ff9800; margin:0 0 10px 0;">üëâ Step 2: Load Reference</h4>
                        <p style="margin:0; font-size:0.9rem; line-height:1.6;">
                            Choose a reference: <br/>
                            ‚Ä¢ <strong>Upload</strong> your own video/image<br/>
                            ‚Ä¢ <strong>Capture</strong> your perfect pose<br/>
                            ‚Ä¢ <strong>Load Preset</strong> (Tatkar, Chakkar, etc.)
                        </p>
                    </div>

                    <div style="background:white; padding:15px; border-radius:8px; border-left:4px solid #9d174d;">
                        <h4 style="color:#9d174d; margin:0 0 10px 0;">üëâ Step 3: Select Speed (Laya)</h4>
                        <p style="margin:0; font-size:0.9rem; line-height:1.6;">
                            Click speed buttons: <strong>Ekgun (1x)</strong> for slow practice, up to <strong>16x</strong> for advanced. Metronome and tolerance adjust automatically!
                        </p>
                    </div>

                    <div style="background:white; padding:15px; border-radius:8px; border-left:4px solid #2196F3;">
                        <h4 style="color:#2196F3; margin:0 0 10px 0;">üëâ Step 4: Practice & Align</h4>
                        <p style="margin:0; font-size:0.9rem; line-height:1.6;">
                            Follow the <strong>directional tips</strong> at the bottom of video. When alignment turns <span style="color:#4CAF50; font-weight:bold;">green</span>, hold for 2 seconds to count a rep!
                        </p>
                    </div>

                    <div style="background:white; padding:15px; border-radius:8px; border-left:4px solid #673ab7;">
                        <h4 style="color:#673ab7; margin:0 0 10px 0;">üé¨ Studio Mode (Optional)</h4>
                        <p style="margin:0; font-size:0.9rem; line-height:1.6;">
                            Click <strong>"üé¨ Studio Mode"</strong> for fullscreen immersive practice with live feedback overlay. Perfect for focused training sessions!
                        </p>
                    </div>

                    <div style="background:white; padding:15px; border-radius:8px; border-left:4px solid #f44336;">
                        <h4 style="color:#f44336; margin:0 0 10px 0;">üìä Track Progress</h4>
                        <p style="margin:0; font-size:0.9rem; line-height:1.6;">
                            Use <strong>"‚ñ∂ Start Session"</strong> to track time, reps, and scores. View your progress dashboard to see weekly improvement!
                        </p>
                    </div>
                </div>

                <div style="background:#fff9c4; padding:15px; border-radius:8px; margin-top:15px; border-left:4px solid #fbc02d;">
                    <h4 style="color:#f57f17; margin:0 0 10px 0;">‚ö° Pro Tips</h4>
                    <ul style="margin:0; padding-left:20px; font-size:0.9rem; line-height:1.8;">
                        <li><strong>Good lighting</strong> helps pose detection accuracy</li>
                        <li><strong>Ghost overlay</strong> (captured references only) shows your target pose transparently</li>
                        <li><strong>Metronome</strong> syncs with laya speed - use it to keep rhythm</li>
                        <li><strong>Speech recognition</strong> in Taal Audio Practice works best in quiet environments</li>
                        <li><strong>Difficulty levels</strong> adjust tolerance: Beginner (¬±20¬∞), Intermediate (¬±15¬∞), Advanced (¬±10¬∞)</li>
                        <li><strong>Mobile</strong>? Rotate to landscape for best experience</li>
                    </ul>
                </div>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 12px; margin-top: 15px; border: 2px solid var(--accent);">
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; align-items:center;">
                    <div id="poseStatus" style="background: rgba(0,0,0,0.75); color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem;">Camera Off</div>
                    <div id="alignmentBox" style="background:#fff; border:1px solid #eee; padding:8px 12px; border-radius:6px;">
                        <strong>Alignment:</strong> <span id="alignmentScore">--%</span> <span id="holdStatus" style="margin-left:8px; color:#4CAF50;"></span>
                        <span title="Alignment score shows how well you match the reference pose. 85%+ turns green!" style="cursor:help; color:#999; margin-left:4px;">‚ÑπÔ∏è</span>
                    </div>
                    <div style="background:#f5f5f5; border:1px solid #eee; padding:8px 12px; border-radius:6px;">
                        <strong>Speed:</strong> <span id="currentSpeedName" style="color:var(--primary);">Ekgun (1x)</span>
                        <span title="Laya speed: Faster speeds tighten tolerance and sync metronome BPM" style="cursor:help; color:#999; margin-left:4px;">‚ÑπÔ∏è</span>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns:2fr 1.2fr; gap:14px; align-items:start;">
                    <div style="background:#0b0b0b; border-radius:10px; padding:10px; position:relative;">
                        <div style="position: relative; background: #000; border-radius: 8px; overflow: hidden; min-height: 420px;">
                            <video id="poseVideo" width="100%" height="100%" autoplay playsinline style="display: block;"></video>
                            <canvas id="poseCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                            <div id="directionalTips" style="position:absolute; bottom:10px; left:10px; right:10px; background: rgba(0,0,0,0.65); color: #fff; padding: 10px 12px; border-radius: 8px; font-size: 0.95rem; line-height: 1.5;">Start camera to see live guidance...</div>
                        </div>

                        <div style="background: linear-gradient(135deg, #fdf2f8, #fce4ec); padding: 12px; border-radius: 8px; margin-top: 10px;">
                            <h4 style="margin: 0 0 8px 0; color: var(--primary);">üìä Live Posture Metrics</h4>
                            <div id="poseMetrics" style="font-size: 0.9rem; line-height: 1.6; display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:6px 12px;">
                                <div><strong>Left Arm Angle:</strong> <span id="leftArmAngle">--</span></div>
                                <div><strong>Right Arm Angle:</strong> <span id="rightArmAngle">--</span></div>
                                <div><strong>Left Knee Angle:</strong> <span id="leftKneeAngle">--</span></div>
                                <div><strong>Right Knee Angle:</strong> <span id="rightKneeAngle">--</span></div>
                                <div><strong>Back Alignment:</strong> <span id="backAlignment">--</span></div>
                                <div><strong>Pose Confidence:</strong> <span id="poseConfidence">--</span></div>
                            </div>
                        </div>

                        <div style="background: white; padding: 12px; border: 2px solid var(--accent); border-radius: 8px; margin-top: 10px;">
                            <h4 style="margin: 0 0 8px 0; color: var(--primary);">ü§ñ AI Feedback</h4>
                            <div id="poseFeedback" style="font-size: 0.95rem; color: #333; min-height: 70px; line-height: 1.5;">
                                Start camera to get real-time posture analysis!
                            </div>
                        </div>
                    </div>

                    <div style="background:white; border:1px solid #eee; border-radius:10px; padding:12px; display:flex; flex-direction:column; gap:10px;">
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <label style="background:white; border:2px solid #eee; padding:10px 14px; border-radius:6px; cursor:pointer; font-weight:500;">
                                üìπ Upload Video
                                <input id="refVideoInput" type="file" accept="video/*" onchange="uploadReferenceVideo(event)" style="display:none;" />
                            </label>
                            <label style="background:white; border:2px solid #eee; padding:10px 14px; border-radius:6px; cursor:pointer; font-weight:500;">
                                üñºÔ∏è Upload Image
                                <input id="refImageInput2" type="file" accept="image/*" onchange="uploadReferenceImage(event)" style="display:none;" />
                            </label>
                            <label style="background:#fff; border:2px dashed #ddd; padding:10px 14px; border-radius:6px; cursor:pointer; font-weight:500;">
                                üì§ Load Still
                                <input id="refImageInput" type="file" accept="image/*" onchange="uploadReferenceImage(event)" style="display:none;" />
                            </label>
                            <button onclick="loadPresetReference()" style="background:#9d174d; color:white; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; font-weight:bold; flex:1; min-width:140px;">üìö Load Preset</button>
                            <button onclick="clearReference()" style="background:#ff4444; color:white; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; font-weight:bold;" title="Clear uploaded reference">üóëÔ∏è Clear</button>
                        </div>

                        <div style="background:#f5f5f5; padding:12px; border-radius:8px;">
                            <p style="margin:0 0 8px 0; font-size:0.9rem; color:#666;">Reference Guide</p>
                            <video id="refVideo" width="100%" height="auto" controls style="display:none; border-radius:6px; margin-bottom:8px;"></video>
                            <img id="refImage2" alt="Reference" style="display:none; max-width:100%; border-radius:6px; margin-bottom:8px;" />
                            <img id="refPreview" alt="Reference pose" style="max-width: 100%; border-radius: 6px; border: 1px solid #eee; display:none;" />
                            <div id="refStatus" style="font-size:0.9rem; color:#999;">No reference loaded</div>
                            <div id="refInfo" style="font-size:0.85rem; color:#666; margin-top:6px;"></div>
                        </div>

                        <div style="background:linear-gradient(135deg, #fdf2f8, #fff1f2); padding:12px; border-radius:8px;">
                            <p style="margin:0 0 6px 0; font-size:0.9rem; color:#666;">üìñ Preset References:</p>
                            <div style="font-size:0.85rem; line-height:1.6; display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:6px;">
                                <label><input type="radio" name="presetRef" value="tatkar" /> Tatkar Basic (1-8)</label>
                                <label><input type="radio" name="presetRef" value="chakkar" /> Chakkar Prep</label>
                                <label><input type="radio" name="presetRef" value="namaskar" /> Namaskar Stance</label>
                            </div>
                        </div>

                        <div style="background:#f5f5f5; padding:12px; border-radius:8px;">
                            <h4 style="margin:0 0 8px 0; color: var(--primary);">üìä Side-by-Side Compare</h4>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                <div style="background:white; padding:10px; border-radius:6px; border:1px solid #eee;">
                                    <h5 style="margin:0 0 6px 0; font-size:0.9rem; color:#666;">üì∏ Reference</h5>
                                    <div id="refCompare" style="font-size:0.85rem; line-height:1.6;">
                                        <p style="margin:0; color:#999;">No reference loaded</p>
                                    </div>
                                </div>
                                <div style="background:white; padding:10px; border-radius:6px; border:1px solid #eee;">
                                    <h5 style="margin:0 0 6px 0; font-size:0.9rem; color:#666;">üé• Live</h5>
                                    <div id="liveCompare" style="font-size:0.85rem; line-height:1.6;">
                                        <p style="margin:0; color:#999;">Start camera</p>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top:10px; padding:10px; background:#fff; border-radius:6px; border:1px dashed #ddd;">
                                <h5 style="margin:0 0 6px 0; font-size:0.9rem; color:#666;">üìà Angle Deltas</h5>
                                <div id="deltaCompare" style="font-size:0.85rem; line-height:1.6;">
                                    <p style="margin:0; color:#999;">Waiting...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
                    <button onclick="startPoseDetection()" style="flex:1; min-width:140px; background: #4CAF50; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold;">üìπ Start Camera</button>
                    <button onclick="stopPoseDetection()" style="flex:1; min-width:140px; background: #ff4444; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold;">‚èπ Stop Camera</button>
                    <button onclick="enterStudioMode()" style="flex:1; min-width:140px; background: #9d174d; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold;">üé¨ Studio Mode</button>
                    <button onclick="captureReferencePose()" style="flex:1; min-width:140px; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold;">üì∏ Capture Reference</button>
                    <button onclick="compareWithReference()" style="flex:1; min-width:140px; background: #ff9800; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold;">üîç Compare Pose</button>
                    <label style="display:flex; align-items:center; gap:6px; background:#f5f5f5; padding:10px 12px; border-radius:6px; border:1px solid #eee;">
                        <input id="ghostToggle" type="checkbox" onchange="toggleGhostOverlay(this.checked)" /> Ghost overlay
                    </label>
                </div>

                <div style="display:grid; grid-template-columns:1.2fr 1fr; gap:12px; margin-top:12px; align-items:start;">
                    <div style="background: white; padding: 12px; border: 2px solid var(--accent); border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--primary);">‚ö° Speed & Laya</h4>
                        <p style="font-size: 0.85rem; color: #666; margin: 0 0 10px 0;">Laya buttons also tighten pose tolerance as you speed up.</p>
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(70px, 1fr)); gap:8px; margin-bottom:10px;">
                            <button onclick="setTrainingSpeed(1)" class="speedBtn active" style="background:#4CAF50; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.9rem;">üü¢ Ekgun<br/>1x</button>
                            <button onclick="setTrainingSpeed(2)" class="speedBtn" style="background:#8BC34A; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.9rem;">üü° Dugan<br/>2x</button>
                            <button onclick="setTrainingSpeed(3)" class="speedBtn" style="background:#FFC107; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.9rem;">üü† Tigun<br/>3x</button>
                            <button onclick="setTrainingSpeed(4)" class="speedBtn" style="background:#FF9800; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.9rem;">üî¥ Chaugun<br/>4x</button>
                            <button onclick="setTrainingSpeed(8)" class="speedBtn" style="background:#f44336; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.9rem;">üíé Atha<br/>8x</button>
                            <button onclick="setTrainingSpeed(16)" class="speedBtn" style="background:#c62828; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.9rem;">‚ö° 16x</button>
                        </div>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                            <label>BPM
                                <input id="metroBPM" type="number" min="40" max="200" value="96" style="margin-left:6px; width:80px;">
                            </label>
                            <label>Taal
                                <select id="metroTaal" style="margin-left:6px;">
                                    <option value="Teentaal|16">Teentaal (16)</option>
                                    <option value="Jhaptaal|10">Jhaptaal (10)</option>
                                    <option value="Ektaal|12">Ektaal (12)</option>
                                </select>
                            </label>
                            <button onclick="toggleMetronome()" id="metroBtn" style="background:#4CAF50; color:white; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; font-weight:bold;">‚ñ∂ Start Metronome</button>
                            <span id="metroBeat" style="display:inline-block; width:20px; height:20px; border-radius:50%; background:#eee; border:2px solid #ccc;"></span>
                            <span id="metroCount" style="margin-left:8px; color:#666;">Beat: 0 / 16</span>
                        </div>
                        <div id="speedInfo" style="font-size:0.9rem; color:#333; margin-top:8px;">
                            Faster laya will demand tighter alignment. Practice with metronome and compare after each cycle.
                        </div>
                    </div>

                    <div style="background: white; padding: 12px; border: 2px solid var(--accent); border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--primary);">üë£ Kathak Step Presets</h4>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                            <select id="presetSelect">
                                <option value="">Select Preset</option>
                                <option value="tatkar_basic">Tatkar (basic 1-8)</option>
                                <option value="chakkar_prep">Chakkar Prep</option>
                                <option value="namaskar">Namaskar Stance</option>
                            </select>
                            <button onclick="applyPreset()" style="background:#9d174d; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">Load Preset</button>
                            <button onclick="saveCurrentAsPreset()" style="background:#607d8b; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">Save Current as Preset</button>
                        </div>
                        <div id="presetInfo" style="font-size:0.9rem; color:#666; margin-top:8px;"></div>
                    </div>
                </div>

                <div style="background: white; padding: 12px; border: 2px solid var(--accent); border-radius: 8px; margin-top: 12px;">
                    <h4 style="margin: 0 0 8px 0; color: var(--primary);">üìà Practice Session</h4>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div style="background:#f5f5f5; padding:10px; border-radius:6px; text-align:center;">
                            <div style="font-size:0.85rem; color:#666;">‚è±Ô∏è Session Time</div>
                            <div id="sessionTime" style="font-size:1.3rem; font-weight:bold; color:var(--primary);">0:00</div>
                        </div>
                        <div style="background:#f5f5f5; padding:10px; border-radius:6px; text-align:center;">
                            <div style="font-size:0.85rem; color:#666;">‚úÖ Reps Completed</div>
                            <div id="repCount" style="font-size:1.3rem; font-weight:bold; color:#4CAF50;">0</div>
                        </div>
                        <div style="background:#f5f5f5; padding:10px; border-radius:6px; text-align:center;">
                            <div style="font-size:0.85rem; color:#666;">üèÜ Best Score</div>
                            <div id="bestScore" style="font-size:1.3rem; font-weight:bold; color:#ff9800;">--%</div>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button onclick="startSession()" id="sessStartBtn" style="flex:1; min-width:150px; background:#4CAF50; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">‚ñ∂ Start Session</button>
                        <button onclick="endSession()" style="flex:1; min-width:150px; background:#ff4444; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">‚èπ End Session</button>
                        <button onclick="viewSessionSummary()" style="flex:1; min-width:150px; background:#2196F3; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">üìä Summary</button>
                    </div>
                    <div id="sessionInfo" style="font-size:0.85rem; color:#666; margin-top:8px;"></div>
                </div>

                <!-- Form Checklist -->
                <div style="background: white; padding: 15px; border: 2px solid var(--accent); border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--primary);">‚úÖ Pre-Practice Checklist</h4>
                    <div id="formChecklist" style="font-size:0.9rem; line-height:1.8;">
                        <label style="display:block; margin:6px 0;"><input type="checkbox" class="formCheck"/> Spine straight & long</label>
                        <label style="display:block; margin:6px 0;"><input type="checkbox" class="formCheck"/> Knees soft & engaged</label>
                        <label style="display:block; margin:6px 0;"><input type="checkbox" class="formCheck"/> Shoulders relaxed</label>
                        <label style="display:block; margin:6px 0;"><input type="checkbox" class="formCheck"/> Breathing steady</label>
                        <label style="display:block; margin:6px 0;"><input type="checkbox" class="formCheck"/> Camera positioned well</label>
                    </div>
                </div>

                <!-- Difficulty Selector -->
                <div style="background: white; padding: 15px; border: 2px solid var(--accent); border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--primary);">üéØ Difficulty Level</h4>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button onclick="setDifficulty('beginner')" id="diffBtn_beginner" class="diffBtn" style="background:#4CAF50; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:bold;">üå± Beginner</button>
                        <button onclick="setDifficulty('intermediate')" id="diffBtn_intermediate" class="diffBtn active" style="background:#9d174d; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:bold;">‚ö° Intermediate</button>
                        <button onclick="setDifficulty('advanced')" id="diffBtn_advanced" class="diffBtn" style="background:#c62828; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:bold;">üî• Advanced</button>
                    </div>
                    <div id="diffInfo" style="font-size:0.85rem; color:#666; margin-top:8px;">Tolerance: ¬±15¬∞ (Intermediate)</div>
                </div>

                <!-- Taal Audio Practice -->
                <div style="background: white; padding: 15px; border: 2px solid var(--accent); border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--primary);">üéµ Taal Audio Practice</h4>
                    <p style="font-size: 0.85rem; color: #666; margin: 0 0 12px 0;">Listen to taal patterns or record your bol recitation</p>
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                        <div style="background:#f5f5f5; padding:12px; border-radius:8px;">
                            <h5 style="margin:0 0 10px 0; font-size:0.95rem; color:#666;">üîä Listen & Learn</h5>
                            <div style="display:flex; flex-direction:column; gap:8px;">
                                <select id="taalPattern" style="padding:8px; border-radius:6px; border:1px solid #ddd;">
                                    <option value="teentaal">Teentaal Theka (16 beats)</option>
                                    <option value="jhaptaal">Jhaptaal Theka (10 beats)</option>
                                    <option value="ektaal">Ektaal Theka (12 beats)</option>
                                    <option value="dadra">Dadra Theka (6 beats)</option>
                                </select>
                                <button onclick="playTaalPattern()" style="background:#9d174d; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">‚ñ∂ Play Taal Pattern</button>
                                <button onclick="stopTaalPattern()" style="background:#ff4444; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer;">‚èπ Stop</button>
                                <div id="taalPlaybackInfo" style="font-size:0.85rem; color:#666; margin-top:6px;">Select a taal to play</div>
                            </div>
                        </div>
                        
                        <div style="background:#f5f5f5; padding:12px; border-radius:8px;">
                            <h5 style="margin:0 0 10px 0; font-size:0.95rem; color:#666;">üé§ Record Bols</h5>
                            <div style="display:flex; flex-direction:column; gap:8px;">
                                <button onclick="startBolRecording()" id="bolRecBtn" style="background:#4CAF50; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">üé§ Start Recording</button>
                                <button onclick="stopBolRecording()" style="background:#ff4444; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer;">‚èπ Stop</button>
                                <button onclick="playBolRecording()" id="bolPlayBtn" style="background:#2196F3; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer;" disabled>‚ñ∂ Play Back</button>
                                <button onclick="saveBolRecording()" id="bolSaveBtn" style="background:#607d8b; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer;" disabled>üíæ Save</button>
                                <div id="bolRecordingInfo" style="font-size:0.85rem; color:#666; margin-top:6px;">Ready to record</div>
                            </div>
                        </div>
                    </div>

                    <div style="background:linear-gradient(135deg, #fdf2f8, #fff1f2); padding:12px; border-radius:8px; margin-bottom:12px;">
                        <h5 style="margin:0 0 10px 0; font-size:0.95rem; color:#666;">üó£Ô∏è Speech Recognition (Beta)</h5>
                        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
                            <button onclick="startBolListening()" id="listenBtn" style="background:#4CAF50; color:white; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; font-weight:bold;">üéôÔ∏è Listen to Bols</button>
                            <button onclick="stopBolListening()" style="background:#ff4444; color:white; border:none; padding:10px 14px; border-radius:6px; cursor:pointer;">‚èπ Stop</button>
                            <span id="listeningStatus" style="color:#666; font-size:0.85rem;">Speak: Ta, Dha, Dhin, Ge, Na...</span>
                        </div>
                        <div id="bolTranscript" style="background:#fff; padding:10px; border-radius:6px; min-height:60px; border:1px solid #ddd; font-size:0.9rem; line-height:1.6;">
                            Recognized bols will appear here...
                        </div>
                        <div style="display:flex; gap:8px; margin-top:10px;">
                            <button onclick="clearBolTranscript()" style="background:#999; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">Clear</button>
                            <button onclick="copyBolTranscript()" style="background:#607d8b; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">üìã Copy</button>
                        </div>
                    </div>

                    <div style="background:#f5f5f5; padding:12px; border-radius:8px;">
                        <h5 style="margin:0 0 10px 0; font-size:0.95rem; color:#666;">üìö Saved Bol Recordings</h5>
                        <div id="bolRecordingsList" style="font-size:0.85rem; line-height:1.8;">
                            No saved recordings yet
                        </div>
                    </div>
                </div>

                <!-- Progress Dashboard -->
                <div style="background: white; padding: 15px; border: 2px solid var(--accent); border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--primary);">üìä Progress Dashboard</h4>
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:15px;">
                        <div style="background:linear-gradient(135deg, #ffebee, #fdf2f8); padding:12px; border-radius:6px;">
                            <div style="font-size:0.85rem; color:#666;">üî• Current Streak</div>
                            <div id="streakDays" style="font-size:1.5rem; font-weight:bold; color:#c62828;">0 days</div>
                        </div>
                        <div style="background:linear-gradient(135deg, #fdf2f8, #fff1f2); padding:12px; border-radius:6px;">
                            <div style="font-size:0.85rem; color:#666;">üìà Weekly Sessions</div>
                            <div id="weeklyCount" style="font-size:1.5rem; font-weight:bold; color:#ff5722;">0</div>
                        </div>
                    </div>

                    <div style="background:#f5f5f5; padding:12px; border-radius:6px; margin-bottom:12px;">
                        <h5 style="margin:0 0 10px 0; font-size:0.9rem; color:#666;">üìâ Weekly Average Scores</h5>
                        <canvas id="progressChart" width="350" height="150" style="width:100%; max-width:350px;"></canvas>
                    </div>

                    <div style="background:#f5f5f5; padding:12px; border-radius:6px; margin-bottom:12px;">
                        <h5 style="margin:0 0 10px 0; font-size:0.9rem; color:#666;">üèÜ Best Presets (Last 7 days)</h5>
                        <div id="bestPresetsText" style="font-size:0.85rem; line-height:1.6; color:#333;">
                            <p style="margin:0; color:#999;">No data yet</p>
                        </div>
                    </div>

                    <div style="display:flex; gap:8px;">
                        <button onclick="refreshProgress()" style="flex:1; background:#2196F3; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">üîÑ Refresh Stats</button>
                        <button onclick="downloadProgressReport()" style="flex:1; background:#4CAF50; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">üì• Export Report</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Enhanced Studio Mode Overlay -->
    <div id="studioOverlay" class="studio-overlay">
        <div class="studio-header">
            <div class="studio-title">üé≠ Studio Mode</div>
        </div>
        
        <video id="studioVideo" class="studio-video" autoplay playsinline></video>
        <canvas id="studioCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
        
        <div class="studio-timer" id="studioTimer">0:00</div>
        
        <div class="studio-metrics" id="studioMetrics">
            <h4>üìä Live Metrics</h4>
            <div class="studio-metric-row">
                <span>Alignment:</span>
                <span class="studio-metric-value" id="studioAlignment">--%</span>
            </div>
            <div class="studio-metric-row">
                <span>Left Arm:</span>
                <span class="studio-metric-value" id="studioLeftArm">--¬∞</span>
            </div>
            <div class="studio-metric-row">
                <span>Right Arm:</span>
                <span class="studio-metric-value" id="studioRightArm">--¬∞</span>
            </div>
            <div class="studio-metric-row">
                <span>Confidence:</span>
                <span class="studio-metric-value" id="studioConfidence">--%</span>
            </div>
        </div>
        
        <div class="studio-feedback" id="studioFeedback">
            <h4>üí° Live Feedback</h4>
            <div id="studioFeedbackText">Start camera to see live guidance...</div>
        </div>
        
        <div class="studio-controls">
            <button class="btn-record" onclick="toggleStudioRecording()" id="studioRecordBtn">üî¥ Start Recording</button>
            <button class="btn-fullscreen" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
            <button class="btn-exit" onclick="exitStudioMode()">‚úï Exit</button>
        </div>
    </div>

    <script>
        // ============ HELP GUIDE TOGGLE ============
        function toggleHelpGuide() {
            const guide = document.getElementById('helpGuide');
            if (guide.style.display === 'none') {
                guide.style.display = 'block';
                guide.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                guide.style.display = 'none';
            }
        }

        // Show help guide automatically on first visit
        window.addEventListener('load', () => {
            const hasSeenGuide = safeStorage.getItem('hasSeenPoseGuide');
            if (!hasSeenGuide && document.getElementById('pose-training')) {
                setTimeout(() => {
                    const section = document.getElementById('pose-training');
                    if (section && section.style.display !== 'none') {
                        toggleHelpGuide();
                        safeStorage.setItem('hasSeenPoseGuide', 'true');
                    }
                }, 1000);
            }
        });

        // ============ NAVIGATION & SECTION MANAGEMENT ============
        function showSection(id) {
            // Hide all sections
            const sections = document.querySelectorAll('[data-section]');
            sections.forEach(sec => {
                sec.style.display = (sec.id === id) ? '' : 'none';
            });
            
            // Update subnav buttons
            const buttons = document.querySelectorAll('.subnav-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                const btnText = btn.textContent.toLowerCase();
                const isActive = (id === 'write' && btnText.includes('notebook')) ||
                                (id === 'features' && btnText.includes('practice')) ||
                                (id === 'ai-tools' && btnText.includes('ai')) ||
                                (id === 'media' && btnText.includes('media')) ||
                                (id === 'pose-training' && btnText.includes('advanced'));
                if (isActive) btn.classList.add('active');
            });

            // Hide Inspire/AI suggestion box outside notebook/AI tools
            if (aiBox) {
                if (id === 'write' || id === 'ai-tools') {
                    aiBox.style.display = lastAiContent ? 'block' : 'none';
                } else {
                    aiBox.style.display = 'none';
                }
            }
            
            // Scroll to workspace
            const workspace = document.querySelector('.workspace');
            if (workspace) workspace.scrollIntoView({ behavior: 'smooth' });
        }

        const notebook = document.getElementById('notebook');
        const beatCounter = document.getElementById('beatCounter');
        const aiBox = document.getElementById('aiBox');
        const aiText = document.getElementById('aiText');
        
        let lastAiContent = "";

        // Safe localStorage wrapper to handle privacy mode
        const safeStorage = {
            getItem: (key) => {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    console.warn('localStorage blocked:', key);
                    return null;
                }
            },
            setItem: (key, value) => {
                try {
                    localStorage.setItem(key, value);
                } catch (e) {
                    console.warn('localStorage blocked:', key);
                }
            },
            removeItem: (key) => {
                try {
                    localStorage.removeItem(key);
                } catch (e) {
                    console.warn('localStorage blocked:', key);
                }
            }
        };

        // LOAD SAVED COMPOSITION ON PAGE START
        window.addEventListener('DOMContentLoaded', () => {
            try {
                const saved = localStorage.getItem('kathakNotes');
                if (saved) {
                    notebook.value = saved;
                    notebook.dispatchEvent(new Event('input'));
                }
            } catch (e) {
                console.warn('localStorage access blocked by privacy settings');
            }
            // Show AI Tools section by default
            showSection('ai-tools');
        });

        // 1. BEAT COUNTER LOGIC
        // Counts beats based on Taal structure
        function countBeats() {
            const text = notebook.value.trim();
            if(!text) {
                beatCounter.innerText = "0 Beats";
                return;
            }
            const taal = document.getElementById('taal').value;
            let totalBeats = 0;
            
            // Count syllables (Bols)
            const bols = text.split(/\s+/).filter(b => b.length > 0);
            totalBeats = bols.length;
            
            // Estimate taal cycles
            let taalsInCycle = 16; // Teen Taal default
            if (taal.includes("Jhap")) taalsInCycle = 10;
            if (taal.includes("Rupak")) taalsInCycle = 7;
            if (taal.includes("Dadra")) taalsInCycle = 6;
            
            const cycles = Math.floor(totalBeats / taalsInCycle);
            beatCounter.innerText = `${totalBeats} Bols | ${cycles} ${taal.split('(')[0].trim()} Cycle(s)`;
        }

        notebook.addEventListener('input', countBeats);
        document.getElementById('taal').addEventListener('change', countBeats);

        // 2. AI GENERATION LOGIC
        async function askAI() {
            const taal = document.getElementById('taal').value;
            const type = document.getElementById('stepType').value;
            const context = notebook.value; // Send current text so AI knows context

            const btn = document.querySelector('.inspire-btn');
            const originalText = btn.innerText;
            
            // UI Loading State
            btn.innerText = "Thinking...";
            btn.disabled = true;
            aiBox.style.display = 'block';
            aiText.innerText = "Composing dance steps...";

            try {
                const response = await fetch('/generate-step', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ taal, type, context })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                if (data.error) {
                    aiText.innerText = `Error: ${data.error}`;
                    lastAiContent = "";
                } else {
                    lastAiContent = data.result || "";
                    aiText.innerText = lastAiContent || "No suggestion generated";
                }

            } catch (err) {
                console.error("Error:", err);
                aiText.innerText = "‚ùå Connection lost. Make sure server is running!";
                lastAiContent = "";
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // 3. ADD SUGGESTION TO TEXTAREA
        function acceptSuggestion() {
            if (!lastAiContent || lastAiContent.trim() === "") {
                aiText.innerText = "No suggestion to add. Click Inspire Me again!";
                return;
            }
            const currentText = notebook.value;
            // Add a new line if text exists, otherwise just add content
            notebook.value = currentText + (currentText ? "\n\n" : "") + lastAiContent;
            aiBox.style.display = 'none';
            // Trigger input event to update beat counter
            notebook.dispatchEvent(new Event('input'));
        }

        // 4. COPY SUGGESTION TO CLIPBOARD
        function copySuggestion() {
            if (!lastAiContent) {
                aiText.innerText = "Nothing to copy!";
                return;
            }
            navigator.clipboard.writeText(lastAiContent).then(() => {
                const originalText = aiText.innerText;
                aiText.innerText = "‚úÖ Copied to clipboard!";
                setTimeout(() => {
                    aiText.innerText = originalText;
                }, 2000);
            });
        }

        // 5. SAVE COMPOSITION TO LOCAL STORAGE
        function saveComposition() {
            const content = notebook.value;
            if (!content.trim()) {
                alert("Nothing to save!");
                return;
            }
            localStorage.setItem('kathakNotes', content);
            alert("‚úÖ Composition saved!");
        }

        // 6. CLEAR NOTES
        function clearNotes() {
            if (confirm("Are you sure? This will clear all your notes.")) {
                notebook.value = "";
                localStorage.removeItem('kathakNotes');
                notebook.dispatchEvent(new Event('input'));
                aiBox.style.display = 'none';
                alert("‚úÖ Notes cleared!");
            }
        }

        // 7. KEYBOARD SHORTCUT (Ctrl+Enter to Inspire)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                askAI();
            }
        });

        // 8. PDF GENERATION LOGIC
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const date = new Date().toLocaleDateString();
            const taal = document.getElementById('taal').value;
            const stepType = document.getElementById('stepType').value;

            // Title
            doc.setFont("times", "bold");
            doc.setFontSize(22);
            doc.setTextColor(157, 23, 77); // Pink color
            doc.text("Kathak Choreography Notes", 20, 20);

            // Metadata
            doc.setFont("helvetica", "normal");
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Taal: ${taal}`, 20, 32);
            doc.text(`Step Type: ${stepType}`, 20, 39);
            doc.text(`Date: ${date}`, 20, 46);

            // Line Divider
            doc.setDrawColor(200);
            doc.line(20, 52, 190, 52);

            // Content
            doc.setFont("times", "normal");
            doc.setFontSize(13);
            doc.setTextColor(0);
            
            const content = notebook.value || "(No notes written)";
            // Wrap text automatically at 170 units wide
            const splitText = doc.splitTextToSize(content, 170);
            
            doc.text(splitText, 20, 60);

            // Footer
            doc.setFont("helvetica", "italic");
            doc.setFontSize(9);
            doc.setTextColor(150);
            doc.text("Created with Natya Note - Your Digital Choreography Companion", 20, 285);

            // Save
            doc.save(`Kathak_Notes_${Date.now()}.pdf`);
        }

        // ============ NEW FEATURES ============

        // METRONOME
        let metronomeActive = false;
        let audioContext;
        let currentTempo = 100;

        function toggleMetronome() {
            const btn = document.getElementById('metroBtn');
            currentTempo = parseInt(document.getElementById('tempo').value);
            
            if (!metronomeActive) {
                metronomeActive = true;
                btn.innerText = "‚è∏ Stop";
                startMetronome();
            } else {
                metronomeActive = false;
                btn.innerText = "‚ñ∂ Play";
                if (audioContext) audioContext.close();
            }
        }

        function startMetronome() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            function playClick() {
                if (!metronomeActive) return;
                
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.frequency.value = 1000;
                gain.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.1);
                
                const beatInterval = (60 / currentTempo) * 1000;
                setTimeout(playClick, beatInterval);
            }
            
            playClick();
        }

        // PRACTICE TIMER
        let timerInterval;
        let totalSeconds = 0;

        function startTimer() {
            if (timerInterval) return;
            timerInterval = setInterval(() => {
                totalSeconds++;
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        function resetTimer() {
            stopTimer();
            totalSeconds = 0;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const mins = Math.floor(totalSeconds / 60);
            const secs = totalSeconds % 60;
            document.getElementById('timerDisplay').innerText = 
                `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // BEAT VISUALIZER
        function drawBeatGrid() {
            const taal = document.getElementById('taal').value;
            const beatGrid = document.getElementById('beatGrid');
            beatGrid.innerHTML = '';
            
            let beats = 16; // Teen Taal
            if (taal.includes('Jhap')) beats = 10;
            if (taal.includes('Rupak')) beats = 7;
            if (taal.includes('Dadra')) beats = 6;
            
            for (let i = 1; i <= beats; i++) {
                const dot = document.createElement('div');
                dot.className = 'beat-dot';
                if (i === 1) dot.classList.add('sam'); // First beat (sam)
                dot.innerText = i;
                beatGrid.appendChild(dot);
            }
        }

        // Initialize beat grid
        drawBeatGrid();
        document.getElementById('taal').addEventListener('change', drawBeatGrid);

        // ============ NEW MEDIA FEATURES ============

        // TAB SWITCHING
        function switchTab(tab) {
            // Hide all content
            document.querySelectorAll('.media-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.media-tab').forEach(el => el.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tab + '-content').classList.add('active');
            event.target.classList.add('active');
        }

        // VIDEO RECORDER
        let mediaStream;
        let mediaRecorder;
        let recordedChunks = [];
        let currentRecording;

        async function startVideoRecorder() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 320, height: 240 },
                    audio: true 
                });
                
                const videoPreview = document.getElementById('videoPreview');
                videoPreview.srcObject = mediaStream;
                
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(mediaStream);
                
                mediaRecorder.ondataavailable = (event) => {
                    recordedChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    currentRecording = new Blob(recordedChunks, { type: 'video/webm' });
                    document.getElementById('recorderStatus').classList.add('recording');
                };
                
                mediaRecorder.start();
                document.getElementById('recorderStatus').innerHTML = 'Recording...';
                document.getElementById('recorderStatus').classList.add('recording');
                document.querySelector('.inspire-btn').disabled = true;
                
            } catch (error) {
                alert('Camera access denied or not available');
                console.error(error);
            }
        }

        function stopVideoRecorder() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaStream.getTracks().forEach(track => track.stop());
                
                document.getElementById('recorderStatus').innerHTML = '‚úÖ Recording saved!';
                document.getElementById('recorderStatus').classList.remove('recording');
                document.querySelector('.inspire-btn').disabled = false;
            }
        }

        function downloadVideo() {
            if (currentRecording) {
                const url = URL.createObjectURL(currentRecording);
                const a = document.createElement('a');
                a.href = url;
                a.download = `practice-${Date.now()}.webm`;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                alert('No recording to download!');
            }
        }

        // SEGMENT NOTES
        let notesList = [];

        function addNote() {
            const input = document.getElementById('noteInput');
            const noteText = input.value.trim();
            
            if (!noteText) {
                alert('Please write a note!');
                return;
            }
            
            const note = {
                id: Date.now(),
                text: noteText,
                time: new Date().toLocaleTimeString()
            };
            
            notesList.push(note);
            input.value = '';
            
            // Save to localStorage
            localStorage.setItem('choreNotes', JSON.stringify(notesList));
            
            renderNotes();
        }

        function deleteNote(id) {
            notesList = notesList.filter(note => note.id !== id);
            localStorage.setItem('choreNotes', JSON.stringify(notesList));
            renderNotes();
        }

        function renderNotes() {
            const notesList_el = document.getElementById('notesList');
            notesList_el.innerHTML = '';
            
            if (notesList.length === 0) {
                notesList_el.innerHTML = '<p style="color: #999; text-align: center;">No notes yet</p>';
                return;
            }
            
            notesList.forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = 'note-item';
                noteEl.innerHTML = `
                    <div>
                        <div>${note.text}</div>
                        <div class="note-time">${note.time}</div>
                    </div>
                    <button class="note-delete" onclick="deleteNote(${note.id})">Delete</button>
                `;
                notesList_el.appendChild(noteEl);
            });
        }

        // Load notes on page start
        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('choreNotes');
            if (saved) {
                notesList = JSON.parse(saved);
                renderNotes();
            }
        });

        // MUSIC PLAYER
        function loadMusic() {
            const file = document.getElementById('musicFile').files[0];
            if (!file) return;
            
            const url = URL.createObjectURL(file);
            document.getElementById('audioPlayer').src = url;
            document.getElementById('musicFileName').textContent = file.name;
            document.getElementById('nowPlaying').textContent = `Now playing: ${file.name}`;
            
            // Save music preference
            localStorage.setItem('selectedMusicName', file.name);
        }

        // ============ NEW INNOVATIVE FEATURES ============

        // 1. RECORDING LIBRARY
        let recordings = [];

        function saveRecording(blob) {
            const recording = {
                id: Date.now(),
                name: `Recording-${recordings.length + 1}`,
                blob: blob,
                date: new Date().toLocaleString(),
                size: (blob.size / 1024 / 1024).toFixed(2) + ' MB'
            };
            recordings.push(recording);
            localStorage.setItem('recordings', JSON.stringify({ids: recordings.map(r => r.id), dates: recordings.map(r => r.date)}));
            renderRecordings();
        }

        function renderRecordings() {
            const list = document.getElementById('recordingsList');
            list.innerHTML = '';
            
            if (recordings.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999;">No recordings yet</p>';
                return;
            }
            
            recordings.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'recording-item';
                item.innerHTML = `
                    <div class="recording-info">
                        <div class="recording-name">${rec.name}</div>
                        <div class="recording-time">${rec.date} ‚Ä¢ ${rec.size}</div>
                    </div>
                    <div class="recording-actions">
                        <button class="btn-play" onclick="playRecording(${rec.id})">‚ñ∂ Play</button>
                        <button class="btn-delete" onclick="deleteRecording(${rec.id})">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function playRecording(id) {
            const rec = recordings.find(r => r.id === id);
            if (rec) {
                const url = URL.createObjectURL(rec.blob);
                const video = document.createElement('video');
                video.src = url;
                video.controls = true;
                video.style.width = '100%';
                alert('Recording will play in new window');
                window.open(url);
            }
        }

        function deleteRecording(id) {
            if (confirm('Delete this recording?')) {
                recordings = recordings.filter(r => r.id !== id);
                renderRecordings();
            }
        }

        // 2. VOICE MEMOS
        let voiceRecorder;
        let voiceChunks = [];
        let voiceMemos = [];

        async function startVoiceMemo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                voiceRecorder = new MediaRecorder(stream);
                voiceChunks = [];
                
                voiceRecorder.ondataavailable = (e) => voiceChunks.push(e.data);
                voiceRecorder.onstop = () => {
                    const blob = new Blob(voiceChunks, { type: 'audio/mp3' });
                    const prompt = prompt('Add a note to this voice memo:');
                    if (prompt) {
                        voiceMemos.push({
                            id: Date.now(),
                            text: prompt,
                            blob: blob,
                            date: new Date().toLocaleTimeString()
                        });
                        renderVoiceMemos();
                        localStorage.setItem('voiceMemos', JSON.stringify(voiceMemos.map(m => ({id: m.id, text: m.text, date: m.date}))));
                    }
                    stream.getTracks().forEach(t => t.stop());
                };
                
                voiceRecorder.start();
                document.querySelector('#voice-content button').innerText = '‚èπ Stop Recording...';
            } catch (e) {
                alert('Microphone access denied');
            }
        }

        function stopVoiceMemo() {
            if (voiceRecorder) {
                voiceRecorder.stop();
                document.querySelector('#voice-content button').innerText = 'üéôÔ∏è Start Recording';
            }
        }

        function renderVoiceMemos() {
            const list = document.getElementById('voiceMemosList');
            list.innerHTML = '';
            
            if (voiceMemos.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999;">No voice memos yet</p>';
                return;
            }
            
            voiceMemos.forEach(memo => {
                const item = document.createElement('div');
                item.className = 'voice-memo-item';
                item.innerHTML = `
                    <div class="voice-memo-text">
                        <div style="font-weight: bold;">${memo.text}</div>
                        <div class="voice-time">${memo.date}</div>
                    </div>
                    <button class="voice-play" onclick="playVoiceMemo(${memo.id})">‚ñ∂ Play</button>
                `;
                list.appendChild(item);
            });
        }

        function playVoiceMemo(id) {
            const memo = voiceMemos.find(m => m.id === id);
            if (memo) {
                const url = URL.createObjectURL(memo.blob);
                const audio = new Audio(url);
                audio.play();
            }
        }

        // 3. BOL SPEED TRAINER
        let currentSpeed = 1.0;

        function setSpeed(speed) {
            currentSpeed = speed;
            document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            updateSpeedDisplay();
        }

        function updateSpeedDisplay() {
            const text = notebook.value.trim();
            if (!text) {
                document.getElementById('speedDisplayText').innerText = 'Type or paste your bols to practice...';
                return;
            }
            
            const words = text.split(/\s+/);
            const delayMs = Math.round((60 / currentSpeed) * 100);
            
            let displayText = '';
            words.forEach((word, i) => {
                displayText += `<span style="display: inline-block; min-width: 60px;">${word}</span> `;
            });
            
            document.getElementById('speedDisplayText').innerHTML = displayText;
            document.getElementById('speedDisplayText').title = `Speed: ${currentSpeed}x (${delayMs}ms between bols)`;
        }

        notebook.addEventListener('input', updateSpeedDisplay);

        // 4. PRACTICE STREAK TRACKER
        let streakData = JSON.parse(localStorage.getItem('streakData') || '{"streak": 0, "lastDate": null, "totalMinutes": 0, "sessionsWeek": 0}');

        function recordPracticeSession() {
            const today = new Date().toDateString();
            const lastDate = streakData.lastDate;
            
            if (lastDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (lastDate === yesterday.toDateString()) {
                    streakData.streak++;
                } else {
                    streakData.streak = 1;
                }
                streakData.lastDate = today;
            }
            
            streakData.totalMinutes += 30; // Default 30 min session
            streakData.sessionsWeek++;
            
            localStorage.setItem('streakData', JSON.stringify(streakData));
            updateStreakDisplay();
            alert('üéâ Practice session recorded! Keep it up!');
        }

        function updateStreakDisplay() {
            document.getElementById('streakNumber').innerText = streakData.streak;
            document.getElementById('totalPracticeTime').innerText = Math.floor(streakData.totalMinutes / 60) + 'h ' + (streakData.totalMinutes % 60) + 'm';
            document.getElementById('sessionsThisWeek').innerText = streakData.sessionsWeek;
            document.getElementById('lastPracticeTime').innerText = streakData.lastDate || 'Never';
        }

        updateStreakDisplay();

        // 5. ENHANCED STUDIO MODE (Full Screen Immersive Recording with Live Feedback)
        let studioMediaStream;
        let studioRecording = false;
        let studioRecorder;
        let studioChunks = [];
        let studioTimer = 0;
        let studioTimerInterval;
        let studioPoseDetector = null;
        let studioAnimationFrame = null;

        async function enterStudioMode() {
            const overlay = document.getElementById('studioOverlay');
            overlay.style.display = 'flex';
            
            try {
                // Use existing pose stream if available, otherwise create new
                if (poseStream) {
                    studioMediaStream = poseStream;
                } else {
                    studioMediaStream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 1280, height: 720 },
                        audio: true
                    });
                }
                
                const video = document.getElementById('studioVideo');
                video.srcObject = studioMediaStream;
                
                // Wait for video to be ready
                await new Promise((resolve) => {
                    if (video.readyState >= 2) return resolve();
                    video.onloadedmetadata = () => {
                        video.play().then(resolve).catch(() => resolve());
                    };
                });
                
                // Start pose detection in studio mode
                await startStudioPoseDetection();
                
            } catch (e) {
                alert('Camera access denied: ' + e.message);
                overlay.style.display = 'none';
            }
        }

        async function startStudioPoseDetection() {
            if (!studioPoseDetector) {
                await ensureTfBackend();
                const detectorConfig = {
                    modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING
                };
                studioPoseDetector = await poseDetection.createDetector(
                    poseDetection.SupportedModels.MoveNet, 
                    detectorConfig
                );
            }
            
            detectStudioPose();
        }

        async function detectStudioPose() {
            if (!studioPoseDetector || !studioMediaStream) return;
            
            const video = document.getElementById('studioVideo');
            const canvas = document.getElementById('studioCanvas');
            const ctx = canvas.getContext('2d');
            
            if (video.readyState < 2) {
                studioAnimationFrame = requestAnimationFrame(detectStudioPose);
                return;
            }
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            try {
                const poses = await studioPoseDetector.estimatePoses(video, { maxPoses: 1, flipHorizontal: true });
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                if (poses.length > 0) {
                    const pose = poses[0];
                    
                    // Draw skeleton on studio canvas
                    drawSkeleton(ctx, pose.keypoints);
                    
                    // Calculate metrics
                    const metrics = calculatePostureMetrics(pose.keypoints);
                    
                    // Update studio UI
                    document.getElementById('studioLeftArm').innerText = metrics.leftArm + '¬∞';
                    document.getElementById('studioRightArm').innerText = metrics.rightArm + '¬∞';
                    document.getElementById('studioConfidence').innerText = metrics.confidence + '%';
                    
                    // Update alignment if reference available
                    if (referenceAngles) {
                        const score = computeAlignmentScore(metrics, referenceAngles);
                        document.getElementById('studioAlignment').innerText = score + '%';
                        
                        // Update feedback
                        const feedbackText = generateStudioFeedback(metrics);
                        document.getElementById('studioFeedbackText').innerHTML = feedbackText;
                    } else {
                        document.getElementById('studioAlignment').innerText = '--%';
                        document.getElementById('studioFeedbackText').innerHTML = 'Load a reference preset or capture one to get live alignment feedback.';
                    }
                }
                
            } catch (error) {
                console.error('Studio pose detection error:', error);
            }
            
            studioAnimationFrame = requestAnimationFrame(detectStudioPose);
        }

        function generateStudioFeedback(metrics) {
            if (!referenceAngles) return 'No reference loaded';
            
            const diffs = {
                leftArm: metrics.leftArm - referenceAngles.leftArm,
                rightArm: metrics.rightArm - referenceAngles.rightArm,
                leftKnee: metrics.leftKnee - referenceAngles.leftKnee,
                rightKnee: metrics.rightKnee - referenceAngles.rightKnee
            };
            
            const msgs = [];
            
            if (Math.abs(diffs.leftArm) > 10) {
                msgs.push(`<div style="margin: 8px 0;">üî∏ Left arm: ${diffs.leftArm > 0 ? 'Lower' : 'Raise'} by ${Math.abs(Math.round(diffs.leftArm))}¬∞</div>`);
            }
            if (Math.abs(diffs.rightArm) > 10) {
                msgs.push(`<div style="margin: 8px 0;">üî∏ Right arm: ${diffs.rightArm > 0 ? 'Lower' : 'Raise'} by ${Math.abs(Math.round(diffs.rightArm))}¬∞</div>`);
            }
            if (Math.abs(diffs.leftKnee) > 10) {
                msgs.push(`<div style="margin: 8px 0;">üî∏ Left knee: ${diffs.leftKnee > 0 ? 'Straighten' : 'Bend more'} by ${Math.abs(Math.round(diffs.leftKnee))}¬∞</div>`);
            }
            if (Math.abs(diffs.rightKnee) > 10) {
                msgs.push(`<div style="margin: 8px 0;">üî∏ Right knee: ${diffs.rightKnee > 0 ? 'Straighten' : 'Bend more'} by ${Math.abs(Math.round(diffs.rightKnee))}¬∞</div>`);
            }
            
            if (msgs.length === 0) {
                return '<div style="color: #4CAF50; font-size: 1.1rem;">‚úÖ Perfect alignment! Hold this pose.</div>';
            }
            
            return msgs.join('');
        }

        function exitStudioMode() {
            const overlay = document.getElementById('studioOverlay');
            overlay.style.display = 'none';
            
            if (studioRecording) {
                toggleStudioRecording();
            }
            
            if (studioAnimationFrame) {
                cancelAnimationFrame(studioAnimationFrame);
                studioAnimationFrame = null;
            }
            
            // Don't stop the stream if it's the main pose stream
            if (studioMediaStream && studioMediaStream !== poseStream) {
                studioMediaStream.getTracks().forEach(t => t.stop());
            }
            
            clearInterval(studioTimerInterval);
            studioTimer = 0;
            document.getElementById('studioTimer').innerText = '0:00';
        }

        function toggleFullscreen() {
            const overlay = document.getElementById('studioOverlay');
            
            if (!document.fullscreenElement) {
                overlay.requestFullscreen().catch(err => {
                    console.log('Fullscreen error:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        function toggleStudioRecording() {
            const btn = document.getElementById('studioRecordBtn');
            
            if (!studioRecording) {
                studioRecording = true;
                studioChunks = [];
                studioTimer = 0;
                btn.innerText = '‚èπ Stop Recording';
                btn.style.background = '#ff4444';
                
                studioRecorder = new MediaRecorder(studioMediaStream);
                studioRecorder.ondataavailable = (e) => studioChunks.push(e.data);
                studioRecorder.start();
                
                studioTimerInterval = setInterval(() => {
                    studioTimer++;
                    const mins = Math.floor(studioTimer / 60);
                    const secs = studioTimer % 60;
                    document.getElementById('studioTimer').innerText = 
                        `${mins}:${secs < 10 ? '0' : ''}${secs}`;
                }, 1000);
            } else {
                studioRecording = false;
                btn.innerText = 'üî¥ Start Recording';
                btn.style.background = '#4CAF50';
                
                studioRecorder.stop();
                clearInterval(studioTimerInterval);
                
                studioRecorder.onstop = () => {
                    const blob = new Blob(studioChunks, { type: 'video/webm' });
                    saveRecording(blob);
                    alert('‚úÖ Studio session recorded and saved!');
                };
            }
        }

        // Load data on start
        window.addEventListener('load', () => {
            const recData = localStorage.getItem('recordings');
            if (recData) {
                const data = JSON.parse(recData);
                renderRecordings();
            }
            
            const voiceData = localStorage.getItem('voiceMemos');
            if (voiceData) {
                voiceMemos = JSON.parse(voiceData);
                renderVoiceMemos();
            }

            initializeChallenges();
        });

                // ============ AI TOOLS: BOL EXPLAINER, VARIATIONS, PRACTICE PLAN ============
                // ============ ADVANCED AI: GESTURE DICTIONARY ============
                async function getGestureInfo() {
                    const gestureName = document.getElementById('gestureName').value.trim();
                    const out = document.getElementById('gestureOutput');
                    if (!gestureName) {
                        out.innerText = 'Please enter a gesture name.';
                        return;
                    }
                    out.innerText = 'Getting gesture info...';
                    try {
                        const r = await fetch('/ai/gesture-dictionary', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ gestureName })
                        });
                        const j = await r.json();
                        if (j.gesture) {
                            out.innerText = j.gesture;
                        } else {
                            out.innerText = j.error || 'No info generated.';
                        }
                    } catch(e) {
                        out.innerText = 'Error: ' + e.message;
                    }
                }
                // ============ ADVANCED AI: MOOD-BASED PRACTICE ============
                async function getMoodPractice() {
                    const mood = document.getElementById('moodMood').value;
                    const time = document.getElementById('moodTime').value;
                    const goals = document.getElementById('moodGoals').value;
                    const out = document.getElementById('moodOutput');
                    out.innerText = 'Getting plan...';
                    try {
                        const r = await fetch('/ai/mood-practice', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ mood, time, goals })
                        });
                        const j = await r.json();
                        if (j.planText) {
                            out.innerText = j.planText;
                        } else if (j.plan) {
                            out.innerText = typeof j.plan === 'string' ? j.plan : JSON.stringify(j.plan, null, 2);
                        } else {
                            out.innerText = j.error || 'No plan generated.';
                        }
                    } catch(e) {
                        out.innerText = 'Error: ' + e.message;
                    }
                }
                // ============ ADVANCED AI: PRACTICE REMINDER ============
                async function getReminder() {
                    const practiceHistory = document.getElementById('reminderHistory').value;
                    const goals = document.getElementById('reminderGoals').value;
                    const out = document.getElementById('reminderOutput');
                    out.innerText = 'Getting reminder...';
                    try {
                        const r = await fetch('/ai/reminder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ practiceHistory, goals })
                        });
                        const j = await r.json();
                        if (j.reminder) {
                            out.innerText = j.reminder;
                        } else {
                            out.innerText = j.error || 'No reminder generated.';
                        }
                    } catch(e) {
                        out.innerText = 'Error: ' + e.message;
                    }
                }
                // ============ ADVANCED AI: POSE SUGGESTION ============
                async function getPoseSuggestions() {
                    const taal = document.getElementById('poseTaal').value;
                    const level = document.getElementById('poseLevel').value;
                    const theme = document.getElementById('poseTheme').value.trim();
                    const out = document.getElementById('poseOutput');
                    out.innerText = 'Suggesting poses...';
                    try {
                        const r = await fetch('/ai/pose-suggestion', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ taal, level, theme })
                        });
                        const j = await r.json();
                            if (j.poses) {
                                const poseText = Array.isArray(j.poses) ? j.poses.join('\n') : j.poses;
                                out.innerText = poseText;
                            } else {
                                out.innerText = j.error || 'No pose suggestions generated.';
                            }
                    } catch(e) {
                        out.innerText = 'Error: ' + e.message;
                    }
                }
                // ============ ADVANCED AI: FEEDBACK ============
                async function getFeedback() {
                    const videoInput = document.getElementById('feedbackVideo');
                    const notes = document.getElementById('feedbackNotes').value;
                    const taal = document.getElementById('feedbackTaal').value;
                    const level = document.getElementById('feedbackLevel').value;
                    const out = document.getElementById('feedbackOutput');
                    out.innerText = 'Getting feedback...';
                    const form = new FormData();
                    if (videoInput.files[0]) form.append('video', videoInput.files[0]);
                    form.append('notes', notes);
                    form.append('taal', taal);
                    form.append('level', level);
                    try {
                        const r = await fetch('/ai/feedback', {
                            method: 'POST',
                            body: form
                        });
                        const j = await r.json();
                        if (j.feedback) {
                            out.innerText = j.feedback;
                        } else {
                            out.innerText = j.error || 'No feedback generated.';
                        }
                    } catch(e) {
                        out.innerText = 'Error: ' + e.message;
                    }
                }
                    // ============ ADVANCED AI: CHOREOGRAPHY GENERATOR ============
                    async function generateChoreo() {
                        const taal = document.getElementById('choreoTaal').value;
                        const level = document.getElementById('choreoLevel').value;
                        const theme = document.getElementById('choreoTheme').value.trim();
                        const length = document.getElementById('choreoLength') ? document.getElementById('choreoLength').value : '5';
                        const out = document.getElementById('choreoOutput');
                        out.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">‚è≥ Generating choreography...</div>';
                        try {
                            const r = await fetch('/ai/choreo-generator', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ taal, level, theme, length })
                            });
                            const j = await r.json();
                            if (j.choreography && Array.isArray(j.choreography) && j.choreography.length > 0) {
                                renderChoreo(j.choreography);
                                // Show action buttons
                                const buttons = document.getElementById('choreActionButtons');
                                if (buttons) buttons.style.display = 'flex';
                            } else if (j.error) {
                                out.innerHTML = `<div style="color:#d32f2f;padding:15px;background:#ffebee;border-radius:6px">‚ùå ${j.error}</div>`;
                            } else {
                                out.innerHTML = '<div style="color:#999;padding:15px">No choreography generated. Please try again.</div>';
                            }
                        } catch(e) {
                            out.innerHTML = `<div style="color:#d32f2f;padding:15px;background:#ffebee;border-radius:6px">‚ö†Ô∏è Error: ${e.message}</div>`;
                        }
                    }
                async function explainBol(){
                    const bol = document.getElementById('aiBolInput').value.trim();
                    if(!bol){ alert('Type a bol'); return; }
                    document.getElementById('aiOutput').innerText = 'Thinking...';
                    try{
                        const r = await fetch('/ai/bol-explain', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ bol })});
                        const j = await r.json();
                        document.getElementById('aiOutput').innerText = j.result || j.error || JSON.stringify(j);
                    }catch(e){ document.getElementById('aiOutput').innerText = 'Error: '+e.message; }
                }

                async function generateVariations(){
                    const bols = document.getElementById('aiVarsInput').value.trim();
                    const count = parseInt(document.getElementById('aiVarsCount').value || '3',10);
                    if(!bols){ alert('Type bols'); return; }
                    document.getElementById('aiOutput').innerText = 'Generating variations...';
                    try{
                        const r = await fetch('/ai/variations',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ bols, count })});
                        const j = await r.json();
                        const arr = j.results || [];
                        document.getElementById('aiOutput').innerText = (arr.length? arr.map((s,i)=>`${i+1}. ${s}`).join('\n') : (j.demo ? JSON.stringify(j) : 'No results'));
                    }catch(e){ document.getElementById('aiOutput').innerText = 'Error: '+e.message; }
                }

                async function generatePlan(){
                    const level = document.getElementById('aiPlanLevel').value;
                    const minutesPerDay = parseInt(document.getElementById('aiPlanMins').value || '30',10);
                    document.getElementById('aiOutput').innerText = 'Creating plan...';
                    try{
                        const r = await fetch('/ai/practice-plan',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ level, minutesPerDay, days:7 })});
                        const j = await r.json();
                        if (j.plan) {
                            const plan = j.plan;
                            if (typeof plan === 'object') {
                                const text = Object.keys(plan).sort((a,b)=>a-b).map(k=>`Day ${k}: ${plan[k]}`).join('\n\n');
                                document.getElementById('aiOutput').innerText = text;
                            } else {
                                document.getElementById('aiOutput').innerText = typeof plan === 'string' ? plan : JSON.stringify(plan);
                            }
                        } else if (j.planText) {
                            document.getElementById('aiOutput').innerText = j.planText;
                        } else {
                            document.getElementById('aiOutput').innerText = JSON.stringify(j);
                        }
                    }catch(e){ document.getElementById('aiOutput').innerText = 'Error: '+e.message; }
                }

                // ============ FEATURE 1: VOICE-TO-TEXT NOTES ============
        let recognition;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
        }

        function startVoiceToText() {
            if (!recognition) {
                alert('Speech recognition not supported in your browser');
                return;
            }

            document.getElementById('voiceToTextArea').value = '';
            document.getElementById('voiceToTextStatus').innerText = 'üé§ Listening...';
            document.getElementById('voiceToTextBtn').style.display = 'none';
            document.getElementById('stopVoiceToTextBtn').style.display = 'block';

            recognition.onstart = () => {
                document.getElementById('voiceToTextStatus').innerText = 'üé§ Listening...';
            };

            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                document.getElementById('voiceToTextArea').value = transcript;
            };

            recognition.onerror = (event) => {
                document.getElementById('voiceToTextStatus').innerText = '‚ùå Error: ' + event.error;
            };

            recognition.start();
        }

        function stopVoiceToText() {
            if (recognition) {
                recognition.stop();
                document.getElementById('voiceToTextStatus').innerText = '‚úÖ Done speaking';
                document.getElementById('voiceToTextBtn').style.display = 'block';
                document.getElementById('stopVoiceToTextBtn').style.display = 'none';
            }
        }

        function saveVoiceNote() {
            const text = document.getElementById('voiceToTextArea').value;
            if (!text.trim()) {
                alert('No notes to save!');
                return;
            }

            const note = {
                id: Date.now(),
                text: text,
                date: new Date().toLocaleString(),
                type: 'voice-note'
            };

            let voiceNotes = JSON.parse(localStorage.getItem('voiceNotes') || '[]');
            voiceNotes.push(note);
            localStorage.setItem('voiceNotes', JSON.stringify(voiceNotes));

            alert('‚úÖ Voice note saved!');
            document.getElementById('voiceToTextArea').value = '';
            document.getElementById('voiceToTextStatus').innerText = '';
        }

        // ============ FEATURE 2: VIDEO COMPARISON ============
        let referenceVideoBlob;

        function loadReferenceVideo() {
            const file = document.getElementById('referenceVideo').files[0];
            if (!file) return;

            referenceVideoBlob = file;
            const url = URL.createObjectURL(file);
            document.getElementById('refVideo').src = url;
        }

        function populateRecordingSelect() {
            const select = document.getElementById('yourRecording');
            select.innerHTML = '<option>Select your recording...</option>';

            recordings.forEach(rec => {
                const option = document.createElement('option');
                option.value = rec.id;
                option.text = rec.name;
                select.appendChild(option);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const observer = setInterval(() => {
                if (recordings.length > 0) {
                    populateRecordingSelect();
                    clearInterval(observer);
                }
            }, 500);
        });

        function syncVideos() {
            const yourVideo = document.getElementById('yourVideo');
            const refVideo = document.getElementById('refVideo');

            if (!yourVideo.src || !refVideo.src) {
                alert('Please select both videos first!');
                return;
            }

            // Sync play - both start at same time
            yourVideo.play();
            refVideo.play();

            // Sync pause
            yourVideo.addEventListener('pause', () => refVideo.pause());
            refVideo.addEventListener('pause', () => yourVideo.pause());

            alert('üîÑ Videos synced! Play in either video to control both.');
        }

        document.getElementById('yourRecording')?.addEventListener('change', function() {
            const recId = parseInt(this.value);
            if (recId) {
                const rec = recordings.find(r => r.id === recId);
                if (rec) {
                    const url = URL.createObjectURL(rec.blob);
                    document.getElementById('yourVideo').src = url;
                }
            }
        });

        // ============ FEATURE 3: DAILY CHALLENGES ============
        const allChallenges = [
            {
                title: 'üéØ 5-Move Drill',
                desc: 'Practice the same 5-move sequence 10 times without mistakes',
                target: 10,
                type: 'repetitions'
            },
            {
                title: '‚ö° Speed Challenge',
                desc: 'Practice your choreography at 1.5x speed for 5 minutes',
                target: 300,
                type: 'seconds'
            },
            {
                title: 'üìπ Record & Review',
                desc: 'Record a 2-minute practice video and review it',
                target: 120,
                type: 'seconds'
            },
            {
                title: 'üî• Endurance',
                desc: 'Practice for 15 minutes straight',
                target: 900,
                type: 'seconds'
            },
            {
                title: 'üéµ Music Sync',
                desc: 'Practice to your background music and stay on beat',
                target: 1,
                type: 'songs'
            },
            {
                title: 'üíØ Perfectionist',
                desc: 'Complete 5 repetitions with zero mistakes',
                target: 5,
                type: 'perfect_reps'
            }
        ];

        let dailyChallenges = [];
        let completedChallenges = [];

        function initializeChallenges() {
            const today = new Date().toDateString();
            const savedData = localStorage.getItem('dailyChallengesData');

            if (savedData) {
                const data = JSON.parse(savedData);
                if (data.date === today) {
                    dailyChallenges = data.challenges;
                    completedChallenges = data.completed;
                    renderChallenges();
                    return;
                }
            }

            // New day - get 3 random challenges
            dailyChallenges = [];
            const shuffled = [...allChallenges].sort(() => Math.random() - 0.5);
            dailyChallenges = shuffled.slice(0, 3);
            completedChallenges = [];

            saveChallengesData();
            renderChallenges();
        }

        function renderChallenges() {
            if (dailyChallenges.length === 0) {
                document.getElementById('challengeDesc').innerText = 'Loading challenges...';
                return;
            }

            const current = dailyChallenges[completedChallenges.length] || dailyChallenges[0];
            document.getElementById('challengeTitle').innerText = current.title;
            document.getElementById('challengeDesc').innerText = current.desc;

            const completed = document.getElementById('completedChallengesCount');
            completed.innerText = completedChallenges.length;

            const list = document.getElementById('completedChallengesList');
            list.innerHTML = '';
            completedChallenges.forEach(c => {
                const div = document.createElement('div');
                div.style.cssText = 'background: #d4edda; padding: 8px; margin: 5px 0; border-radius: 4px; color: #155724;';
                div.innerText = '‚úÖ ' + c;
                list.appendChild(div);
            });
        }

        function startChallenge() {
            const current = dailyChallenges[completedChallenges.length];
            if (!current) {
                alert('üéâ You completed all challenges for today!');
                return;
            }

            alert(`üéØ Challenge Started: ${current.desc}\n\nStart practicing now!`);
        }

        function completeChallenge() {
            const current = dailyChallenges[completedChallenges.length];
            if (current) {
                completedChallenges.push(current.title);
                saveChallengesData();
                renderChallenges();
                alert('üéâ Challenge completed! Great job!');
            }
        }

        function skipChallenge() {
            const current = dailyChallenges[completedChallenges.length];
            if (current) {
                dailyChallenges.push(dailyChallenges.splice(completedChallenges.length, 1)[0]);
                saveChallengesData();
                renderChallenges();
            }
        }

        function saveChallengesData() {
            const today = new Date().toDateString();
            localStorage.setItem('dailyChallengesData', JSON.stringify({
                date: today,
                challenges: dailyChallenges,
                completed: completedChallenges
            }));
        }

        // Auto-complete challenge button (for testing)
        document.addEventListener('DOMContentLoaded', () => {
            const challengesDiv = document.getElementById('challenges-content');
            if (challengesDiv) {
                const completeBtn = document.createElement('button');
                completeBtn.innerText = '‚úÖ Mark Challenge Done';
                completeBtn.style.cssText = 'background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; display: none;';
                completeBtn.id = 'completeChallengBtn';
                completeBtn.onclick = completeChallenge;
                // Find the right place to add it
            }
        });

        // ============ POSE DETECTION & TRAINING (FREE) ============
        let poseDetector = null;
        let poseStream = null;
        let poseAnimationFrame = null;
        let referencePose = null;                // captured image + timestamp
        let lastPoseKeypoints = null;            // last live keypoints
        let capturedRefKeypoints = null;         // keypoints captured from live when capturing ref
        let uploadedRefKeypoints = null;         // keypoints extracted from uploaded image
        let referenceAngles = null;              // angles from reference (captured or uploaded)
        let overlayRefEnabled = false;           // ghost overlay toggle (captured only)
        let holdStart = null;                    // for hold-timer
        let matchedOnce = false;                 // to beep once when matched

        let tfBackendInitialized = false;
        async function ensureTfBackend() {
            if (tfBackendInitialized) return;
            try {
                // Prefer WebGL for performance; fallback to CPU if needed
                const currentBackend = tf.getBackend();
                if (currentBackend === 'webgl' || currentBackend === 'cpu') {
                    tfBackendInitialized = true;
                    return;
                }
                await tf.setBackend('webgl');
                tfBackendInitialized = true;
            } catch (_) {
                try {
                    await tf.setBackend('cpu');
                    tfBackendInitialized = true;
                } catch (e) {
                    console.warn('Could not initialize TensorFlow backend:', e);
                }
            }
            await tf.ready();
        }

        async function startPoseDetection() {
            try {
                document.getElementById('poseStatus').innerText = '‚è≥ Loading AI model...';

                // Ensure TF backend is ready (forces WebGL, avoids WebGPU issues)
                await ensureTfBackend();
                
                // Get camera access
                poseStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                
                const video = document.getElementById('poseVideo');
                video.srcObject = poseStream;

                // Wait for video to be ready
                await new Promise((resolve) => {
                    if (video.readyState >= 2) return resolve();
                    video.onloadedmetadata = () => {
                        video.play().then(resolve).catch(() => resolve());
                    };
                });
                
                // Load MoveNet model (FREE, runs in browser)
                if (!poseDetector) {
                    const detectorConfig = {
                        modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING
                    };
                    poseDetector = await poseDetection.createDetector(
                        poseDetection.SupportedModels.MoveNet, 
                        detectorConfig
                    );
                }
                
                document.getElementById('poseStatus').innerText = '‚úÖ Camera Active';
                document.getElementById('poseFeedback').innerHTML = 'üìπ Camera started! Strike a pose to see live analysis.';
                
                // Start detection loop
                detectPose();
                
            } catch (error) {
                document.getElementById('poseStatus').innerText = '‚ùå Camera Error';
                document.getElementById('poseFeedback').innerHTML = `<span style="color: #ff4444;">Error: ${error.message}<br>Please allow camera access and try again.</span>`;
            }
        }

        async function detectPose() {
            if (!poseDetector || !poseStream) return;
            
            const video = document.getElementById('poseVideo');
            const canvas = document.getElementById('poseCanvas');
            const ctx = canvas.getContext('2d');
            
            // If video not ready yet, try again next frame
            if (video.readyState < 2) {
                poseAnimationFrame = requestAnimationFrame(detectPose);
                return;
            }

            // Match canvas size to video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            try {
                // Detect poses
                const poses = await poseDetector.estimatePoses(video, { maxPoses: 1, flipHorizontal: true });
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                if (poses.length > 0) {
                    const pose = poses[0];
                    lastPoseKeypoints = pose.keypoints;
                    
                    // Draw skeleton
                    drawSkeleton(ctx, pose.keypoints);

                    // Optionally draw ghost overlay of captured reference in same space
                    if (overlayRefEnabled && capturedRefKeypoints) {
                        drawSkeleton(ctx, capturedRefKeypoints, { colorPoint: 'rgba(33,150,243,0.7)', colorBone: 'rgba(33,150,243,0.6)' });
                    }
                    
                    // Calculate and display metrics
                    const metrics = calculatePostureMetrics(pose.keypoints);
                    displayMetrics(metrics);
                    updateDirectionalTips(metrics);

                    // Compute alignment vs reference angles if available
                    if (referenceAngles) {
                        const score = computeAlignmentScore(metrics, referenceAngles);
                        displayAlignment(score);
                        handleHoldLogic(score);
                    }
                    
                    // Update side-by-side compare
                    updateComparePanel();
                    
                    // Get AI feedback every 2 seconds
                    if (!window.lastFeedbackTime || Date.now() - window.lastFeedbackTime > 2000) {
                        getAIPostureFeedback(metrics);
                        window.lastFeedbackTime = Date.now();
                    }
                }
                
            } catch (error) {
                console.error('Pose detection error:', error);
            }
            
            // Continue loop
            poseAnimationFrame = requestAnimationFrame(detectPose);
        }

        function drawSkeleton(ctx, keypoints, style={}) {
            const pointColor = style.colorPoint || '#ff1744';
            const boneColor = style.colorBone || '#00e676';
            // Draw keypoints (joints)
            keypoints.forEach(kp => {
                if (kp.score > 0.3) {
                    ctx.beginPath();
                    ctx.arc(kp.x, kp.y, 8, 0, 2 * Math.PI);
                    ctx.fillStyle = pointColor;
                    ctx.fill();
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            });
            
            // Draw skeleton connections
            const connections = [
                [5, 6], [5, 7], [7, 9], [6, 8], [8, 10],   // Arms
                [5, 11], [6, 12], [11, 12],                 // Torso
                [11, 13], [13, 15], [12, 14], [14, 16]     // Legs
            ];
            
            ctx.strokeStyle = boneColor;
            ctx.lineWidth = 3;
            
            connections.forEach(([i, j]) => {
                const kp1 = keypoints[i];
                const kp2 = keypoints[j];
                if (kp1.score > 0.3 && kp2.score > 0.3) {
                    ctx.beginPath();
                    ctx.moveTo(kp1.x, kp1.y);
                    ctx.lineTo(kp2.x, kp2.y);
                    ctx.stroke();
                }
            });
        }

        function calculatePostureMetrics(keypoints) {
            // Calculate joint angles
            const leftArm = calculateAngle(
                keypoints[5],  // left shoulder
                keypoints[7],  // left elbow
                keypoints[9]   // left wrist
            );
            
            const rightArm = calculateAngle(
                keypoints[6],  // right shoulder
                keypoints[8],  // right elbow
                keypoints[10]  // right wrist
            );
            
            const leftKnee = calculateAngle(
                keypoints[11], // left hip
                keypoints[13], // left knee
                keypoints[15]  // left ankle
            );
            
            const rightKnee = calculateAngle(
                keypoints[12], // right hip
                keypoints[14], // right knee
                keypoints[16]  // right ankle
            );
            
            // Back alignment (shoulder to hip angle)
            const backAngle = calculateAngle(
                keypoints[0],  // nose
                keypoints[5],  // left shoulder
                keypoints[11]  // left hip
            );
            
            // Average confidence
            const avgConfidence = keypoints.reduce((sum, kp) => sum + kp.score, 0) / keypoints.length;
            
            return {
                leftArm: Math.round(leftArm),
                rightArm: Math.round(rightArm),
                leftKnee: Math.round(leftKnee),
                rightKnee: Math.round(rightKnee),
                backAlignment: Math.round(backAngle),
                confidence: Math.round(avgConfidence * 100)
            };
        }

        function calculateAngle(p1, p2, p3) {
            if (!p1 || !p2 || !p3 || p1.score < 0.3 || p2.score < 0.3 || p3.score < 0.3) {
                return 0;
            }
            
            const radians = Math.atan2(p3.y - p2.y, p3.x - p2.x) - 
                           Math.atan2(p1.y - p2.y, p1.x - p2.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            
            if (angle > 180.0) {
                angle = 360 - angle;
            }
            
            return angle;
        }

        function displayMetrics(metrics) {
            document.getElementById('leftArmAngle').innerText = metrics.leftArm + '¬∞';
            document.getElementById('rightArmAngle').innerText = metrics.rightArm + '¬∞';
            document.getElementById('leftKneeAngle').innerText = metrics.leftKnee + '¬∞';
            document.getElementById('rightKneeAngle').innerText = metrics.rightKnee + '¬∞';
            document.getElementById('backAlignment').innerText = metrics.backAlignment + '¬∞';
            document.getElementById('poseConfidence').innerText = metrics.confidence + '%';
        }

        function updateDirectionalTips(metrics) {
            const tipsEl = document.getElementById('directionalTips');
            if (!tipsEl) return;
            
            // Only show tips if camera is active
            if (!poseStream) {
                tipsEl.innerText = 'Start camera to see live guidance...';
                return;
            }
            
            if (!referenceAngles) {
                tipsEl.innerText = 'Load a reference (capture, upload, or preset) to get live directional tips.';
                return;
            }
            const msgs = [];
            const diffs = {
                leftArm: metrics.leftArm - referenceAngles.leftArm,
                rightArm: metrics.rightArm - referenceAngles.rightArm,
                leftKnee: metrics.leftKnee - referenceAngles.leftKnee,
                rightKnee: metrics.rightKnee - referenceAngles.rightKnee,
                back: metrics.backAlignment - referenceAngles.backAlignment
            };

            function dir(label, diff, upWord, downWord, tight=8) {
                if (Math.abs(diff) < tight) return;
                msgs.push(`${label}: ${diff > 0 ? downWord : upWord} ${Math.abs(Math.round(diff))}¬∞`);
            }

            dir('Left arm', diffs.leftArm, 'Lift', 'Lower');
            dir('Right arm', diffs.rightArm, 'Lift', 'Lower');
            dir('Left knee', diffs.leftKnee, 'Bend more', 'Straighten');
            dir('Right knee', diffs.rightKnee, 'Bend more', 'Straighten');
            dir('Back', diffs.back, 'Straighten', 'Slightly relax', 5);

            if (msgs.length === 0) {
                tipsEl.innerText = 'Great! You are matching the reference. Hold steady.';
            } else {
                tipsEl.innerText = msgs.join(' | ');
            }
        }

        function calculateAnglesFromKeypoints(kps) {
            if (!kps) return null;
            return {
                leftArm: Math.round(calculateAngle(kps[5], kps[7], kps[9])),
                rightArm: Math.round(calculateAngle(kps[6], kps[8], kps[10])),
                leftKnee: Math.round(calculateAngle(kps[11], kps[13], kps[15])),
                rightKnee: Math.round(calculateAngle(kps[12], kps[14], kps[16])),
                backAlignment: Math.round(calculateAngle(kps[0], kps[5], kps[11]))
            };
        }

        function computeAlignmentScore(metrics, ref) {
            const keys = ['leftArm','rightArm','leftKnee','rightKnee','backAlignment'];
            let acc = 0;
            let count = 0;
            keys.forEach(k => {
                if (ref[k] && metrics[k] >= 0) {
                    const diff = Math.abs(metrics[k] - ref[k]);
                    // 0 diff => 1.0, 45¬∞ diff => 0.0
                    const norm = Math.max(0, 1 - (diff / 45));
                    acc += norm;
                    count += 1;
                }
            });
            if (count === 0) return 0;
            return Math.round((acc / count) * 100);
        }

        function displayAlignment(score) {
            const el = document.getElementById('alignmentScore');
            el.innerText = score + '%';
            el.style.color = score >= 85 ? '#2e7d32' : (score >= 60 ? '#f57c00' : '#c62828');
        }

        function handleHoldLogic(score) {
            const holdEl = document.getElementById('holdStatus');
            const threshold = 85; // percent
            const holdSecs = 2;   // seconds
            if (score >= threshold) {
                if (!holdStart) holdStart = Date.now();
                const elapsed = (Date.now() - holdStart) / 1000;
                if (elapsed >= holdSecs) {
                    holdEl.innerText = '‚úÖ Pose matched';
                    if (!matchedOnce) { matchedOnce = true; beep(440, 0.15); }
                } else {
                    holdEl.innerText = `‚è≥ Hold ${Math.ceil(holdSecs - elapsed)}s`;
                }
            } else {
                holdStart = null;
                holdEl.innerText = '';
                matchedOnce = false;
            }
        }

        function beep(freq=440, duration=0.2) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.frequency.value = freq; osc.type = 'sine';
                gain.gain.setValueAtTime(0.001, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.05, ctx.currentTime + 0.01);
                osc.start();
                setTimeout(() => { osc.stop(); ctx.close(); }, duration * 1000);
            } catch {}
        }

        async function getAIPostureFeedback(metrics) {
            // Only get feedback if camera is actually running
            if (!poseStream || !lastPoseKeypoints) return;
            
            try {
                const response = await fetch('/ai/pose-suggestion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        taal: 'Teentaal',
                        level: currentDifficulty,
                        theme: `Current pose metrics: Left arm ${metrics.leftArm}¬∞, Right arm ${metrics.rightArm}¬∞, Left knee ${metrics.leftKnee}¬∞, Right knee ${metrics.rightKnee}¬∞, Back alignment ${metrics.backAlignment}¬∞. Speed: ${speedLabels[trainingSpeed] || '1x'}. Provide specific feedback on posture improvement for Kathak dance.`
                    })
                });
                
                const data = await response.json();
                if (data.suggestion) {
                    document.getElementById('poseFeedback').innerHTML = `<strong>üí° AI Feedback:</strong><br>${data.suggestion}`;
                }
            } catch (error) {
                // Silently fail - feedback is optional
            }
        }

        // ============ METRONOME & TAAL ============
        let metroTimer = null;
        let metroBeatCount = 0;
        let metroTotalBeats = 16;
        function toggleMetronome() {
            const btn = document.getElementById('metroBtn');
            const bpm = parseInt(document.getElementById('metroBPM').value || '96', 10);
            const [taalName, taalBeatsStr] = (document.getElementById('metroTaal').value || 'Teentaal|16').split('|');
            metroTotalBeats = parseInt(taalBeatsStr, 10) || 16;
            const effectiveBpm = bpm * (trainingSpeed || 1);
            const intervalMs = Math.round(60000 / effectiveBpm);
            if (metroTimer) {
                clearInterval(metroTimer);
                metroTimer = null;
                btn.innerText = '‚ñ∂ Start Metronome';
                document.getElementById('metroBeat').style.background = '#eee';
                document.getElementById('metroCount').innerText = `Beat: 0 / ${metroTotalBeats}`;
                return;
            }
            btn.innerText = '‚èπ Stop Metronome';
            metroBeatCount = 0;
            metroTimer = setInterval(() => {
                metroBeatCount = (metroBeatCount % metroTotalBeats) + 1;
                const beatEl = document.getElementById('metroBeat');
                const countEl = document.getElementById('metroCount');
                beatEl.style.background = metroBeatCount === 1 ? '#ff6b6b' : '#9d174d';
                countEl.innerText = `Beat: ${metroBeatCount} / ${metroTotalBeats}`;
                beep(metroBeatCount === 1 ? 660 : 440, 0.08);
            }, intervalMs);
        }

        // ============ KATHAK STEP PRESETS ============
        const presets = {
            tatkar_basic: {
                name: 'Tatkar (basic 1-8)',
                info: 'Footwork pattern over 8 beats; keep torso upright, arms relaxed.',
                targetAngles: { leftArm: 20, rightArm: 20, leftKnee: 30, rightKnee: 30, backAlignment: 170 }
            },
            chakkar_prep: {
                name: 'Chakkar Prep',
                info: 'Prepare for spin: arms rounded at shoulder height, knees soft.',
                targetAngles: { leftArm: 60, rightArm: 60, leftKnee: 20, rightKnee: 20, backAlignment: 175 }
            },
            namaskar: {
                name: 'Namaskar Stance',
                info: 'Palms joined, elbows out, spine long and neutral.',
                targetAngles: { leftArm: 40, rightArm: 40, leftKnee: 10, rightKnee: 10, backAlignment: 180 }
            }
        };

        function applyPreset() {
            const val = document.getElementById('presetSelect').value;
            if (!val || !presets[val]) { document.getElementById('presetInfo').innerText = 'Select a preset to load.'; return; }
            referenceAngles = presets[val].targetAngles;
            capturedRefKeypoints = null;
            overlayRefEnabled = false;
            const ghostToggle = document.getElementById('ghostToggle');
            if (ghostToggle) ghostToggle.checked = false;
            document.getElementById('presetInfo').innerText = `${presets[val].name} ‚Äî ${presets[val].info}`;
            document.getElementById('poseFeedback').innerHTML = 'üéØ Preset loaded. Align your angles to match targets until the score turns green.';
        }

        function saveCurrentAsPreset() {
            if (!referenceAngles) { alert('Set a reference first (capture or load preset) to save.'); return; }
            const name = prompt('Enter a name for this preset');
            if (!name) return;
            const custom = JSON.parse(localStorage.getItem('customPresets') || '{}');
            const key = name.toLowerCase().replace(/\s+/g, '_');
            custom[key] = { name, info: 'Custom preset', targetAngles: referenceAngles };
            localStorage.setItem('customPresets', JSON.stringify(custom));
            // Add to select
            const sel = document.getElementById('presetSelect');
            const opt = document.createElement('option');
            opt.value = key; opt.textContent = name + ' (custom)';
            sel.appendChild(opt);
            document.getElementById('presetInfo').innerText = `Saved preset: ${name}`;
        }

        // ============ STEP VISUALIZER (REMOVED - Replaced with Real Reference) ============
        // Stub functions kept for compatibility
        function toggleStepAnimation() { alert('Use the Kathak Reference Library to upload real videos/images instead!'); }

        // ============ TAAL AUDIO PRACTICE ============
        let taalAudioContext = null;
        let taalBeepNodes = [];
        let taalPlaybackTimer = null;
        let bolRecorder = null;
        let bolRecordingStream = null;
        let bolRecordedChunks = [];
        let bolRecordedBlob = null;
        let bolRecognition = null;
        let bolTranscriptText = '';

        function ensureTaalAudioContext() {
            if (taalAudioContext && taalAudioContext.state === 'closed') {
                taalAudioContext = null;
            }
            if (!taalAudioContext) {
                const Ctx = window.AudioContext || window.webkitAudioContext;
                taalAudioContext = Ctx ? new Ctx() : null;
            }
            return taalAudioContext;
        }

        function stopAllTaalBeeps() {
            taalBeepNodes.forEach(node => {
                try { node.osc.stop(); } catch (_) {}
            });
            taalBeepNodes = [];
            if (taalAudioContext) {
                try { taalAudioContext.close(); } catch (_) {}
                taalAudioContext = null;
            }
        }

        function playTaalBeep(freq = 440, duration = 0.14) {
            const ctx = ensureTaalAudioContext();
            if (!ctx) return;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.frequency.value = freq;
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.001, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.06, ctx.currentTime + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + duration);
            const node = { osc, gain };
            taalBeepNodes.push(node);
            osc.onended = () => {
                const idx = taalBeepNodes.indexOf(node);
                if (idx >= 0) taalBeepNodes.splice(idx, 1);
            };
            osc.start();
            osc.stop(ctx.currentTime + duration + 0.02);
        }

        // Taal patterns with syllables
        const taalPatterns = {
            teentaal: {
                name: 'Teentaal',
                beats: 16,
                bols: ['Dha', 'Dhin', 'Dhin', 'Dha', 'Dha', 'Dhin', 'Dhin', 'Dha', 'Dha', 'Tin', 'Tin', 'Ta', 'Ta', 'Dhin', 'Dhin', 'Dha'],
                accents: [0, 4, 8, 12] // Sam positions
            },
            jhaptaal: {
                name: 'Jhaptaal',
                beats: 10,
                bols: ['Dhin', 'Na', 'Dhin', 'Dhin', 'Na', 'Tin', 'Na', 'Dhin', 'Dhin', 'Na'],
                accents: [0, 2, 6]
            },
            ektaal: {
                name: 'Ektaal',
                beats: 12,
                bols: ['Dhin', 'Dhin', 'Dha', 'Ge', 'Ti', 'Ra', 'Ki', 'Ta', 'Dha', 'Ge', 'Ti', 'Ra'],
                accents: [0, 4, 8]
            },
            dadra: {
                name: 'Dadra',
                beats: 6,
                bols: ['Dha', 'Dhin', 'Na', 'Dha', 'Tin', 'Na'],
                accents: [0, 3]
            }
        };

        function playTaalPattern() {
            const selected = document.getElementById('taalPattern').value;
            const pattern = taalPatterns[selected];
            if (!pattern) return;

            stopTaalPattern(); // Stop any playing pattern

            const bpm = parseInt(document.getElementById('metroBPM').value || 96);
            const effectiveBpm = bpm * (trainingSpeed || 1);
            const intervalMs = Math.round(60000 / effectiveBpm);

            let beatIndex = 0;
            document.getElementById('taalPlaybackInfo').innerHTML = `<strong>Playing:</strong> ${pattern.name}<br/><span style="color:var(--primary);">Beat 1 of ${pattern.beats}</span>`;

            taalPlaybackTimer = setInterval(() => {
                const bol = pattern.bols[beatIndex];
                const isSam = pattern.accents.includes(beatIndex);
                const freq = isSam ? 660 : 440;
                playTaalBeep(freq, 0.12);

                document.getElementById('taalPlaybackInfo').innerHTML = `<strong>${pattern.name}:</strong> ${bol}<br/><span style="color:var(--primary);">Beat ${beatIndex + 1} of ${pattern.beats}</span>`;

                beatIndex = (beatIndex + 1) % pattern.beats;
            }, intervalMs);
        }

        function stopTaalPattern() {
            if (taalPlaybackTimer) {
                clearInterval(taalPlaybackTimer);
                taalPlaybackTimer = null;
                document.getElementById('taalPlaybackInfo').innerText = 'Playback stopped';
            }
            stopAllTaalBeeps();
        }

        async function startBolRecording() {
            try {
                bolRecordingStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                bolRecorder = new MediaRecorder(bolRecordingStream);
                bolRecordedChunks = [];

                bolRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) bolRecordedChunks.push(e.data);
                };

                bolRecorder.onstop = () => {
                    bolRecordedBlob = new Blob(bolRecordedChunks, { type: 'audio/webm' });
                    document.getElementById('bolPlayBtn').disabled = false;
                    document.getElementById('bolSaveBtn').disabled = false;
                    document.getElementById('bolRecordingInfo').innerHTML = '<span style="color:#4CAF50;">‚úÖ Recording complete! Use Play Back or Save.</span>';
                };

                bolRecorder.start();
                document.getElementById('bolRecBtn').innerText = 'üî¥ Recording...';
                document.getElementById('bolRecBtn').disabled = true;
                document.getElementById('bolRecordingInfo').innerHTML = '<span style="color:#ff4444;">üî¥ Recording in progress...</span>';

            } catch (error) {
                alert('Microphone access denied: ' + error.message);
            }
        }

        function stopBolRecording() {
            if (bolRecorder && bolRecorder.state === 'recording') {
                bolRecorder.stop();
                bolRecordingStream.getTracks().forEach(track => track.stop());
                document.getElementById('bolRecBtn').innerText = 'üé§ Start Recording';
                document.getElementById('bolRecBtn').disabled = false;
            }
        }

        function playBolRecording() {
            if (!bolRecordedBlob) return;
            const url = URL.createObjectURL(bolRecordedBlob);
            const audio = new Audio(url);
            audio.play();
            document.getElementById('bolRecordingInfo').innerText = '‚ñ∂ Playing back recording...';
            audio.onended = () => {
                document.getElementById('bolRecordingInfo').innerHTML = '<span style="color:#4CAF50;">‚úÖ Playback complete</span>';
            };
        }

        function saveBolRecording() {
            if (!bolRecordedBlob) return;
            const name = prompt('Name for this bol recording:', `Bol_${new Date().toLocaleTimeString()}`);
            if (!name) return;

            const recordings = JSON.parse(localStorage.getItem('bolRecordings') || '[]');
            
            // Convert blob to base64 for storage
            const reader = new FileReader();
            reader.onloadend = () => {
                recordings.push({
                    id: Date.now(),
                    name: name,
                    date: new Date().toLocaleString(),
                    data: reader.result
                });
                localStorage.setItem('bolRecordings', JSON.stringify(recordings));
                refreshBolRecordingsList();
                document.getElementById('bolRecordingInfo').innerHTML = '<span style="color:#4CAF50;">‚úÖ Saved!</span>';
            };
            reader.readAsDataURL(bolRecordedBlob);
        }

        function refreshBolRecordingsList() {
            const recordings = JSON.parse(localStorage.getItem('bolRecordings') || '[]');
            const listEl = document.getElementById('bolRecordingsList');
            
            if (recordings.length === 0) {
                listEl.innerText = 'No saved recordings yet';
                return;
            }

            let html = '';
            recordings.forEach(rec => {
                html += `
                    <div style="background:#fff; padding:8px; margin:6px 0; border-radius:6px; border:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong>${rec.name}</strong><br/>
                            <span style="font-size:0.8rem; color:#666;">${rec.date}</span>
                        </div>
                        <div style="display:flex; gap:4px;">
                            <button onclick="playStoredBol(${rec.id})" style="background:#2196F3; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">‚ñ∂</button>
                            <button onclick="deleteStoredBol(${rec.id})" style="background:#ff4444; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            listEl.innerHTML = html;
        }

        function playStoredBol(id) {
            const recordings = JSON.parse(localStorage.getItem('bolRecordings') || '[]');
            const rec = recordings.find(r => r.id === id);
            if (!rec) return;

            const audio = new Audio(rec.data);
            audio.play();
        }

        function deleteStoredBol(id) {
            if (!confirm('Delete this recording?')) return;
            let recordings = JSON.parse(localStorage.getItem('bolRecordings') || '[]');
            recordings = recordings.filter(r => r.id !== id);
            localStorage.setItem('bolRecordings', JSON.stringify(recordings));
            refreshBolRecordingsList();
        }

        function startBolListening() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                alert('Speech recognition not supported in this browser. Try Chrome or Edge.');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            bolRecognition = new SpeechRecognition();
            bolRecognition.continuous = true;
            bolRecognition.interimResults = true;
            bolRecognition.lang = 'en-IN'; // Indian English for better bol recognition

            bolRecognition.onstart = () => {
                document.getElementById('listenBtn').innerText = 'üéôÔ∏è Listening...';
                document.getElementById('listenBtn').disabled = true;
                document.getElementById('listeningStatus').innerHTML = '<span style="color:#4CAF50;">üéôÔ∏è Speak your bols now...</span>';
            };

            bolRecognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = bolTranscriptText;

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                bolTranscriptText = finalTranscript;
                document.getElementById('bolTranscript').innerHTML = 
                    `<span style="color:#333;">${finalTranscript}</span><span style="color:#999;">${interimTranscript}</span>`;
            };

            bolRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                document.getElementById('listeningStatus').innerHTML = '<span style="color:#ff4444;">Error: ' + event.error + '</span>';
            };

            bolRecognition.onend = () => {
                document.getElementById('listenBtn').innerText = 'üéôÔ∏è Listen to Bols';
                document.getElementById('listenBtn').disabled = false;
                document.getElementById('listeningStatus').innerHTML = '<span style="color:#666;">Stopped</span>';
            };

            bolRecognition.start();
        }

        function stopBolListening() {
            if (bolRecognition) {
                bolRecognition.stop();
            }
        }

        function clearBolTranscript() {
            bolTranscriptText = '';
            document.getElementById('bolTranscript').innerText = 'Recognized bols will appear here...';
        }

        function copyBolTranscript() {
            if (!bolTranscriptText.trim()) {
                alert('Nothing to copy');
                return;
            }
            navigator.clipboard.writeText(bolTranscriptText).then(() => {
                alert('‚úÖ Copied to clipboard!');
            });
        }

        // Load saved recordings on page load
        window.addEventListener('load', () => {
            refreshBolRecordingsList();
        });

        // ============ KATHAK REFERENCE & SPEED TRAINING ============
        let trainingSpeed = 1;
        const speedLabels = {
            1: 'üü¢ Ekgun (1x)',
            2: 'üü° Dugan (2x)',
            3: 'üü† Tigun (3x)',
            4: 'üî¥ Chaugun (4x)',
            5: 'üíú Pancham (5x)',
            8: 'üíé Atha (8x)',
            16: '‚ö° 16x Speed'
        };

        function setTrainingSpeed(multiplier) {
            trainingSpeed = multiplier;
            document.querySelectorAll('.speedBtn').forEach(b => b.classList.remove('active'));
            event.target.closest('button').classList.add('active');
            document.getElementById('currentSpeedName').innerText = speedLabels[multiplier];
            
            // Apply speed to alignment tolerance: faster = stricter
            const strictness = (multiplier - 1) * 2; // 2¬∞ stricter per multiplier level
            const adjustedTolerance = Math.max(5, difficultySettings[currentDifficulty].tolerance - strictness);
            
            // Sync metronome tempo if running
            if (metroTimer) {
                toggleMetronome(); // stop
                setTimeout(() => toggleMetronome(), 100); // restart with new speed
            }
            
            // Sync reference video playback speed if loaded
            const refVideo = document.getElementById('refVideo');
            if (refVideo && refVideo.src && !refVideo.paused) {
                refVideo.playbackRate = multiplier;
            }
            
            document.getElementById('speedInfo').innerHTML = `
                <p style="margin:0 0 8px 0;"><strong>Current Speed:</strong> <span style="color:var(--primary);">${speedLabels[multiplier]}</span></p>
                <p style="margin:0;">Tolerance: ¬±${adjustedTolerance}¬∞ | Metronome: ${Math.round(96 * multiplier)} BPM</p>
                <p style="margin:6px 0 0 0; font-size:0.85rem; color:#666;">Faster laya demands tighter alignment. Metronome and reference video will sync automatically.</p>
            `;
        }

        function uploadReferenceVideo(ev) {
            const file = ev.target.files && ev.target.files[0];
            if (!file) return;
            
            const url = URL.createObjectURL(file);
            const video = document.getElementById('refVideo');
            video.src = url;
            video.style.display = 'block';
            video.playbackRate = trainingSpeed; // sync with current laya speed
            
            // Update playback rate when user plays video
            video.addEventListener('play', () => {
                video.playbackRate = trainingSpeed;
            }, { once: true });
            
            const img = document.getElementById('refImage2');
            img.style.display = 'none';
            
            document.getElementById('refStatus').innerText = `üìπ Video loaded: ${file.name} (${trainingSpeed}x speed)`;
            document.getElementById('poseFeedback').innerHTML = `üé¨ Reference video loaded at ${speedLabels[trainingSpeed]}. Video will play at current laya speed. Use Compare panel to check angles.`;
        }

        function uploadReferenceImage(ev) {
            const file = ev.target.files && ev.target.files[0];
            if (!file) return;
            
            const url = URL.createObjectURL(file);
            const img = document.getElementById('refImage2');
            img.src = url;
            img.style.display = 'block';
            
            const video = document.getElementById('refVideo');
            video.style.display = 'none';
            
            document.getElementById('refStatus').innerText = `üñºÔ∏è Image loaded: ${file.name}`;
            document.getElementById('poseFeedback').innerHTML = 'üì∏ Reference image loaded. Align your live pose to match the angles shown in the Compare panel.';
        }

        function loadPresetReference() {
            const selected = document.querySelector('input[name="presetRef"]:checked').value;
            if (!selected) { alert('Select a preset first'); return; }
            
            const presets = {
                tatkar: { name: 'Tatkar Basic (1-8 beats)', desc: 'Footwork pattern staying upright' },
                chakkar: { name: 'Chakkar Prep', desc: 'Prepare for spin with rounded arms' },
                namaskar: { name: 'Namaskar Stance', desc: 'Palms joined, elbows out, long spine' }
            };
            
            const preset = presets[selected];
            document.getElementById('refStatus').innerText = `üìö ${preset.name} - ${preset.desc}`;
            document.getElementById('poseFeedback').innerHTML = `‚úÖ Preset "${preset.name}" loaded! Use the Compare panel to see target angles. Try different speeds.`;
        }

        // ============ SIDE-BY-SIDE COMPARE ============
        function updateComparePanel() {
            // Reference angles
            if (referenceAngles) {
                const refHtml = `
                    Left Arm: ${referenceAngles.leftArm}¬∞<br/>
                    Right Arm: ${referenceAngles.rightArm}¬∞<br/>
                    Left Knee: ${referenceAngles.leftKnee}¬∞<br/>
                    Right Knee: ${referenceAngles.rightKnee}¬∞<br/>
                    Back: ${referenceAngles.backAlignment}¬∞
                `;
                document.getElementById('refCompare').innerHTML = refHtml;
            }
            // Live angles
            if (lastPoseKeypoints) {
                const live = calculatePostureMetrics(lastPoseKeypoints);
                const liveHtml = `
                    Left Arm: ${live.leftArm}¬∞<br/>
                    Right Arm: ${live.rightArm}¬∞<br/>
                    Left Knee: ${live.leftKnee}¬∞<br/>
                    Right Knee: ${live.rightKnee}¬∞<br/>
                    Back: ${live.backAlignment}¬∞
                `;
                document.getElementById('liveCompare').innerHTML = liveHtml;
                
                // Deltas
                if (referenceAngles) {
                    const deltaHtml = `
                        Left Arm: <span style="color:${Math.abs(live.leftArm - referenceAngles.leftArm) < 10 ? '#2e7d32' : '#c62828'}">${(live.leftArm - referenceAngles.leftArm) > 0 ? '+' : ''}${live.leftArm - referenceAngles.leftArm}¬∞</span><br/>
                        Right Arm: <span style="color:${Math.abs(live.rightArm - referenceAngles.rightArm) < 10 ? '#2e7d32' : '#c62828'}">${(live.rightArm - referenceAngles.rightArm) > 0 ? '+' : ''}${live.rightArm - referenceAngles.rightArm}¬∞</span><br/>
                        Left Knee: <span style="color:${Math.abs(live.leftKnee - referenceAngles.leftKnee) < 10 ? '#2e7d32' : '#c62828'}">${(live.leftKnee - referenceAngles.leftKnee) > 0 ? '+' : ''}${live.leftKnee - referenceAngles.leftKnee}¬∞</span><br/>
                        Right Knee: <span style="color:${Math.abs(live.rightKnee - referenceAngles.rightKnee) < 10 ? '#2e7d32' : '#c62828'}">${(live.rightKnee - referenceAngles.rightKnee) > 0 ? '+' : ''}${live.rightKnee - referenceAngles.rightKnee}¬∞</span><br/>
                        Back: <span style="color:${Math.abs(live.backAlignment - referenceAngles.backAlignment) < 5 ? '#2e7d32' : '#c62828'}">${(live.backAlignment - referenceAngles.backAlignment) > 0 ? '+' : ''}${live.backAlignment - referenceAngles.backAlignment}¬∞</span>
                    `;
                    document.getElementById('deltaCompare').innerHTML = deltaHtml;
                }
            }
        }

        // ============ SESSION TRACKING ============
        let sessionActive = false;
        let sessionStart = null;
        let sessionTimer = null;
        let sessionMetrics = { reps: 0, bestScore: 0, avgScore: 0, scores: [], holds: 0 };
        let currentDifficulty = 'intermediate';
        const difficultySettings = {
            beginner: { tolerance: 20, holdSecs: 1, name: 'üå± Beginner (¬±20¬∞, 1s hold)' },
            intermediate: { tolerance: 15, holdSecs: 2, name: '‚ö° Intermediate (¬±15¬∞, 2s hold)' },
            advanced: { tolerance: 10, holdSecs: 3, name: 'üî• Advanced (¬±10¬∞, 3s hold)' }
        };

        function startSession() {
            sessionActive = true;
            sessionStart = Date.now();
            sessionMetrics = { reps: 0, bestScore: 0, avgScore: 0, scores: [], holds: 0 };
            document.getElementById('sessStartBtn').innerText = '‚è∏ Pause Session';
            document.getElementById('sessionInfo').innerText = 'üü¢ Session active...';
            sessionTimer = setInterval(updateSessionTime, 1000);
        }

        function updateSessionTime() {
            const elapsed = Math.floor((Date.now() - sessionStart) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('sessionTime').innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function endSession() {
            sessionActive = false;
            if (sessionTimer) clearInterval(sessionTimer);
            document.getElementById('sessStartBtn').innerText = '‚ñ∂ Start Session';
            document.getElementById('sessionInfo').innerText = 'Session ended. Check Summary.';
        }

        function recordRepComplete() {
            if (!sessionActive) return;
            sessionMetrics.reps++;
            const score = parseInt(document.getElementById('alignmentScore').innerText, 10) || 0;
            sessionMetrics.scores.push(score);
            sessionMetrics.bestScore = Math.max(sessionMetrics.bestScore, score);
            sessionMetrics.avgScore = Math.round(sessionMetrics.scores.reduce((a,b)=>a+b,0) / sessionMetrics.scores.length);
            document.getElementById('repCount').innerText = sessionMetrics.reps;
            document.getElementById('bestScore').innerText = sessionMetrics.bestScore + '%';
            document.getElementById('sessionInfo').innerText = `Avg: ${sessionMetrics.avgScore}% | Reps: ${sessionMetrics.reps}`;
            localStorage.setItem('lastSession', JSON.stringify({
                timestamp: new Date().toLocaleString(),
                preset: document.getElementById('presetSelect').value,
                difficulty: currentDifficulty,
                metrics: sessionMetrics
            }));
        }

        function viewSessionSummary() {
            if (sessionMetrics.reps === 0) {
                alert('No session data yet. Start a session and complete reps.');
                return;
            }
            const summary = `
üéØ Session Summary

Reps Completed: ${sessionMetrics.reps}
Best Alignment: ${sessionMetrics.bestScore}%
Average Alignment: ${sessionMetrics.avgScore}%
Difficulty: ${difficultySettings[currentDifficulty].name}

Time: ${document.getElementById('sessionTime').innerText}

Great practice! Keep improving.
            `;
            alert(summary);
        }

        function setDifficulty(level) {
            currentDifficulty = level;
            document.querySelectorAll('.diffBtn').forEach(b => b.style.background = '#999');
            document.getElementById('diffBtn_' + level).style.background = level === 'beginner' ? '#4CAF50' : (level === 'intermediate' ? '#9d174d' : '#c62828');
            document.getElementById('diffInfo').innerText = `Tolerance: ${difficultySettings[level].name}`;
        }

        // Update handleHoldLogic to use difficulty settings and record reps
        function handleHoldLogicImproved(score) {
            const holdEl = document.getElementById('holdStatus');
            const diffSettings = difficultySettings[currentDifficulty];
            
            // Adjust tolerance based on training speed: faster = stricter
            const speedAdjustment = (trainingSpeed - 1) * 2;
            const adjustedTolerance = Math.max(5, diffSettings.tolerance - speedAdjustment);
            const threshold = 100 - adjustedTolerance;
            const holdSecs = diffSettings.holdSecs;
            
            if (score >= threshold) {
                if (!holdStart) holdStart = Date.now();
                const elapsed = (Date.now() - holdStart) / 1000;
                if (elapsed >= holdSecs) {
                    holdEl.innerText = '‚úÖ Rep locked!';
                    if (!matchedOnce) { 
                        matchedOnce = true; 
                        beep(550, 0.15); 
                        recordRepComplete();
                    }
                } else {
                    holdEl.innerText = `‚è≥ Hold ${Math.ceil(holdSecs - elapsed)}s`;
                }
            } else {
                holdStart = null;
                holdEl.innerText = '';
                matchedOnce = false;
            }
        }
        
        // Override the old handleHoldLogic
        handleHoldLogic = handleHoldLogicImproved;

        // ============ PROGRESS DASHBOARD & HISTORY ============
        function initializeProgressTracking() {
            const history = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
            // Keep only last 30 days
            const cutoff = Date.now() - (30 * 24 * 60 * 60 * 1000);
            const filtered = history.filter(h => h.timestamp > cutoff);
            localStorage.setItem('practiceHistory', JSON.stringify(filtered));
        }

        function savePracticeSession() {
            if (sessionMetrics.reps === 0) return;
            const history = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
            history.push({
                timestamp: Date.now(),
                date: new Date().toLocaleDateString(),
                preset: document.getElementById('presetSelect').value || 'custom',
                difficulty: currentDifficulty,
                reps: sessionMetrics.reps,
                bestScore: sessionMetrics.bestScore,
                avgScore: sessionMetrics.avgScore,
                sessionMinutes: Math.floor((Date.now() - sessionStart) / 60000)
            });
            localStorage.setItem('practiceHistory', JSON.stringify(history));
        }

        function getStreakDays() {
            const history = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
            if (history.length === 0) return 0;
            
            const sortedByDate = history.sort((a,b) => b.timestamp - a.timestamp);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let streak = 0;
            let checkDate = new Date(today);
            
            for (let i = 0; i < sortedByDate.length; i++) {
                const sessionDate = new Date(sortedByDate[i].timestamp);
                sessionDate.setHours(0, 0, 0, 0);
                
                if (sessionDate.getTime() === checkDate.getTime()) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else if (sessionDate.getTime() < checkDate.getTime()) {
                    break;
                }
            }
            return streak;
        }

        function getWeeklyStats() {
            const history = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
            const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const weekly = history.filter(h => h.timestamp > weekAgo);
            
            return {
                sessionCount: weekly.length,
                avgScore: weekly.length > 0 ? Math.round(weekly.reduce((a,b) => a + b.avgScore, 0) / weekly.length) : 0,
                totalReps: weekly.reduce((a,b) => a + b.reps, 0),
                byDay: getScoresByDay(weekly)
            };
        }

        function getScoresByDay(sessions) {
            const dayScores = {};
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dayStr = date.toLocaleDateString('en-US', { weekday: 'short' });
                dayScores[dayStr] = null;
            }
            
            sessions.forEach(s => {
                const date = new Date(s.timestamp).toLocaleDateString('en-US', { weekday: 'short' });
                if (dayScores.hasOwnProperty(date)) {
                    dayScores[date] = dayScores[date] ? Math.max(dayScores[date], s.avgScore) : s.avgScore;
                }
            });
            return dayScores;
        }

        function getBestPresets() {
            const history = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
            const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const weekly = history.filter(h => h.timestamp > weekAgo);
            
            const presetStats = {};
            weekly.forEach(s => {
                const preset = s.preset;
                if (!presetStats[preset]) presetStats[preset] = { count: 0, avgScore: 0, scores: [] };
                presetStats[preset].count++;
                presetStats[preset].scores.push(s.avgScore);
            });
            
            Object.keys(presetStats).forEach(key => {
                presetStats[key].avgScore = Math.round(presetStats[key].scores.reduce((a,b)=>a+b,0) / presetStats[key].scores.length);
            });
            
            return Object.entries(presetStats)
                .sort((a,b) => b[1].avgScore - a[1].avgScore)
                .slice(0, 3);
        }

        function drawProgressChart() {
            const stats = getWeeklyStats();
            const canvas = document.getElementById('progressChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const days = Object.entries(stats.byDay);
            const chartWidth = canvas.width - 40;
            const chartHeight = canvas.height - 40;
            const barWidth = chartWidth / days.length;
            
            // Y axis (score 0-100)
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = 20 + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(30, y);
                ctx.lineTo(canvas.width - 10, y);
                ctx.stroke();
                
                ctx.fillStyle = '#999';
                ctx.font = '10px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(100 - (i * 20), 25, y + 3);
            }
            
            // Bars
            days.forEach(([day, score], idx) => {
                const x = 30 + idx * barWidth + barWidth / 4;
                const barHeight = (score || 0) * (chartHeight / 100);
                const y = 20 + chartHeight - barHeight;
                
                ctx.fillStyle = score ? '#ff6b9d' : '#eee';
                ctx.fillRect(x, y, barWidth / 2, barHeight);
                
                ctx.fillStyle = '#666';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(day, x + barWidth / 4, canvas.height - 5);
                
                if (score) {
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 10px Arial';
                    ctx.fillText(score + '%', x + barWidth / 4, y - 5);
                }
            });
        }

        function refreshProgress() {
            const streak = getStreakDays();
            const weekly = getWeeklyStats();
            const bestPresets = getBestPresets();
            
            document.getElementById('streakDays').innerText = streak + ' days';
            document.getElementById('weeklyCount').innerText = weekly.sessionCount;
            
            let presetHtml = '';
            bestPresets.forEach(([preset, stats], idx) => {
                const emoji = idx === 0 ? 'ü•á' : (idx === 1 ? 'ü•à' : 'ü•â');
                presetHtml += `${emoji} ${preset}: ${stats.avgScore}% (${stats.count} sessions)<br/>`;
            });
            document.getElementById('bestPresetsText').innerHTML = presetHtml || '<p style="margin:0; color:#999;">No data yet</p>';
            
            drawProgressChart();
        }

        function downloadProgressReport() {
            const history = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
            const streak = getStreakDays();
            const weekly = getWeeklyStats();
            
            let report = 'üé≠ NATYA NOTE - PROGRESS REPORT\n\n';
            report += `Generated: ${new Date().toLocaleString()}\n\n`;
            report += `üìä STATS\n`;
            report += `Current Streak: ${streak} days\n`;
            report += `Weekly Sessions: ${weekly.sessionCount}\n`;
            report += `Weekly Avg Score: ${weekly.avgScore}%\n`;
            report += `Total Reps (7 days): ${weekly.totalReps}\n\n`;
            report += `üìã RECENT SESSIONS\n`;
            
            history.slice(-10).reverse().forEach(s => {
                report += `${s.date} | ${s.preset} (${s.difficulty}) | Score: ${s.avgScore}% | Reps: ${s.reps}\n`;
            });
            
            // Download as txt
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `natya-progress-${new Date().toLocaleDateString()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initializeProgressTracking();
            refreshProgress();
        });

        // Save session when ending
        const origEndSession = endSession;
        endSession = function() {
            savePracticeSession();
            origEndSession();
        };

        function captureReferencePose() {
            const canvas = document.getElementById('poseCanvas');
            const video = document.getElementById('poseVideo');
            
            if (!poseStream) {
                alert('‚ùå Please start the camera first!');
                return;
            }
            
            // Save current frame as reference
            const refCanvas = document.createElement('canvas');
            refCanvas.width = video.videoWidth;
            refCanvas.height = video.videoHeight;
            const refCtx = refCanvas.getContext('2d');
            refCtx.drawImage(video, 0, 0);
            
            referencePose = {
                image: refCanvas.toDataURL(),
                timestamp: Date.now()
            };
            
            localStorage.setItem('referencePose', JSON.stringify(referencePose));
            // Store keypoints and angles for alignment + ghost overlay
            capturedRefKeypoints = lastPoseKeypoints ? JSON.parse(JSON.stringify(lastPoseKeypoints)) : null;
            referenceAngles = calculateAnglesFromKeypoints(capturedRefKeypoints);
            overlayRefEnabled = !!capturedRefKeypoints;
            const ghostToggle = document.getElementById('ghostToggle');
            if (ghostToggle) ghostToggle.checked = overlayRefEnabled;

            const refPrev = document.getElementById('refPreview');
            if (refPrev) { refPrev.src = referencePose.image; refPrev.style.display = 'block'; }
            const refInfo = document.getElementById('refInfo');
            if (refInfo) refInfo.innerText = 'Captured reference from camera';

            document.getElementById('poseFeedback').innerHTML = '‚úÖ <strong>Reference pose captured!</strong><br>Ghost overlay enabled. Align your pose until alignment is green.';
        }

        async function compareWithReference() {
            if (!referencePose) {
                const saved = localStorage.getItem('referencePose');
                if (saved) {
                    referencePose = JSON.parse(saved);
                } else {
                    alert('‚ùå No reference pose found! Capture one first.');
                    return;
                }
            }
            
            document.getElementById('poseFeedback').innerHTML = 'üîç <strong>Comparing poses...</strong><br>This feature compares your current pose with the reference. Keep practicing!';
            
            // Could add more sophisticated comparison logic here
            setTimeout(() => {
                document.getElementById('poseFeedback').innerHTML = 'üìä <strong>Comparison Complete!</strong><br>Focus on matching arm and leg angles with your reference pose. Practice makes perfect!';
            }, 1500);
        }

        function toggleGhostOverlay(checked) {
            overlayRefEnabled = !!checked;
        }

        function clearReference() {
            // Clear video reference
            const video = document.getElementById('refVideo');
            if (video) {
                video.pause();
                video.src = '';
                video.style.display = 'none';
            }
            
            // Clear image references
            const img = document.getElementById('refImage2');
            if (img) {
                img.src = '';
                img.style.display = 'none';
            }
            
            const refPreview = document.getElementById('refPreview');
            if (refPreview) {
                refPreview.src = '';
                refPreview.style.display = 'none';
            }
            
            // Clear file inputs
            const videoInput = document.getElementById('refVideoInput');
            if (videoInput) videoInput.value = '';
            
            const imageInput = document.getElementById('refImageInput');
            if (imageInput) imageInput.value = '';
            
            const imageInput2 = document.getElementById('refImageInput2');
            if (imageInput2) imageInput2.value = '';
            
            // Clear reference data
            referencePose = null;
            capturedRefKeypoints = null;
            uploadedRefKeypoints = null;
            referenceAngles = null;
            overlayRefEnabled = false;
            
            // Clear ghost overlay toggle
            const ghostToggle = document.getElementById('ghostToggle');
            if (ghostToggle) ghostToggle.checked = false;
            
            // Clear preset selection
            const presetSelect = document.getElementById('presetSelect');
            if (presetSelect) presetSelect.value = '';
            
            // Clear radio buttons
            document.querySelectorAll('input[name="presetRef"]').forEach(radio => radio.checked = false);
            
            // Reset UI displays
            document.getElementById('refStatus').innerText = 'No reference loaded';
            document.getElementById('refInfo').innerText = '';
            document.getElementById('presetInfo').innerText = '';
            document.getElementById('alignmentScore').innerText = '--%';
            document.getElementById('holdStatus').innerText = '';
            document.getElementById('refCompare').innerHTML = '<p style="margin:0; color:#999;">No reference loaded</p>';
            document.getElementById('deltaCompare').innerHTML = '<p style="margin:0; color:#999;">Waiting...</p>';
            document.getElementById('poseFeedback').innerHTML = 'Reference cleared. Upload a new reference or load a preset to continue practice.';
            document.getElementById('directionalTips').innerText = poseStream ? 'Load a reference to get live guidance...' : 'Start camera to see live guidance...';
            
            // Clear localStorage
            localStorage.removeItem('referencePose');
        }

        async function uploadReferenceImage(ev) {
            const file = ev.target.files && ev.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            const img = new Image();
            img.onload = async () => {
                try {
                    await ensureTfBackend();
                    if (!poseDetector) {
                        const detectorConfig = { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING };
                        poseDetector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, detectorConfig);
                    }
                    const poses = await poseDetector.estimatePoses(img);
                    if (poses && poses[0]) {
                        uploadedRefKeypoints = poses[0].keypoints;
                        referenceAngles = calculateAnglesFromKeypoints(uploadedRefKeypoints);
                        capturedRefKeypoints = null; // ghost overlay only for captured
                        overlayRefEnabled = false;
                        const ghostToggle = document.getElementById('ghostToggle');
                        if (ghostToggle) ghostToggle.checked = false;
                        const refPrev = document.getElementById('refPreview');
                        if (refPrev) { refPrev.src = url; refPrev.style.display = 'block'; }
                        const refInfo = document.getElementById('refInfo');
                        if (refInfo) refInfo.innerText = 'Reference loaded from image (ghost overlay disabled)';
                        document.getElementById('poseFeedback').innerHTML = 'üñºÔ∏è Reference image loaded. Align your angles to improve your score!';
                    } else {
                        alert('Could not detect a person in the reference image. Try another image.');
                    }
                } catch (e) {
                    alert('Error processing reference image: ' + e.message);
                }
            };
            img.onerror = () => alert('Failed to load image');
            img.src = url;
        }

        function stopPoseDetection() {
            if (poseAnimationFrame) {
                cancelAnimationFrame(poseAnimationFrame);
                poseAnimationFrame = null;
            }
            
            if (poseStream) {
                poseStream.getTracks().forEach(track => track.stop());
                poseStream = null;
            }
            
            const video = document.getElementById('poseVideo');
            video.srcObject = null;
            
            const canvas = document.getElementById('poseCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            document.getElementById('poseStatus').innerText = 'Camera Off';
            document.getElementById('poseFeedback').innerHTML = 'Camera stopped. Click "Start Camera" to resume training.';
        }
    </script>
</body>
</html>